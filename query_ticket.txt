
╭─── Claude Code v2.1.37 ──────────────────────────────────────────────────────╮
│                                                    │ Tips for getting        │
│                 Welcome back Ethon!                │ started                 │
│                                                    │ Run /init to create a … │
│                       ▐▛███▜▌                      │ ─────────────────────── │
│                      ▝▜█████▛▘                     │ Recent activity         │
│                        ▘▘ ▝▝                       │ No recent activity      │
│                                                    │                         │
│   Opus 4.6 · Claude Pro · waming313@gmail.com's    │                         │
│   Organization                                     │                         │
│     D:\software\develop_tools\git\gitee\ticket     │                         │
╰──────────────────────────────────────────────────────────────────────────────╯

> 你知道中國大陸的購票系統12306嗎                                           
                                                                            

● 是的，我知道中国大陆的 12306（中国铁路客户服务中心）。

  它是中国铁路总公司（现为中国国家铁路集团有限公司）运营的官方铁路购票平台，主要
  特点包括：

  - 官方网站：12306.cn，是中国唯一的官方铁路售票网站
  - 功能：火车票查询、预订、改签、退票、候补购票等
  - 高并发系统：每逢春运、国庆等节假日，系统承受极高的并发访问量，是全球最大的票
  务交易系统之一
  - 技术演进：早期经常因高流量崩溃，后来经过多次架构升级（引入了
  CDN、分布式缓存、排队机制等），稳定性大幅提升
  - 配套 App：铁路12306 手机客户端
  - 实名制：购票需要实名认证

  请问你有什么具体需求？比如：
  - 是在开发与 12306 相关的项目？
  - 需要分析或模拟类似的票务系统？
  - 有其他技术问题想讨论？

  告诉我你的需求，我可以更好地帮助你。

> 那你應該知道中國大陸的普通人每次回家過年有很大概率上買不到火車票，如果要  
  買的話，如果選擇某個車次的更長的車程，或者全程才有機率可以買到對應的車票  
                                                                            

● 是的，这是一个非常普遍的现象，尤其在 春运（春节返乡高峰期） 期间。

  核心问题是：

  1. 短途票更难买 — 热门区间的短途票竞争极为激烈，往往秒光
  2. "买长乘短"策略 — 如果买不到 A→B 的票，可以尝试买 A→C（C 是 B
  之后的站点）的票，因为全程票或更长区间的票往往有更多配额，买到的概率更高
  3. 系统分配机制 — 12306 
  的票额分配会优先保障长途旅客，短途区间释放的票额相对较少

  常见的应对策略包括：
  - 买长乘短：多花一些钱，买更远的站点
  - 候补购票：排队等别人退票
  - 分段购票：把一段行程拆成多段分别买票
  - 换乘中转：通过中间站换乘

  你是不是想做一个 辅助查询/分析工具，比如：
  - 自动查询某条线路上哪些更长区间还有余票？
  - 分析最优的"买长乘短"或分段购票方案？
  - 监控余票变化并提醒？

  如果是的话，可以告诉我你的具体想法，我来帮你设计和实现。

> 對的，我想做一個查詢分析的程序，                                          
                                                                            
  需求:例如輸入目的地，查詢經過該目的地的車次有哪些，我再基於我先處的地理位 
  置最近的城市，從該城市到這些車次起點的車票有哪些                          
                                                                            

● 这是一个很实用的需求！让我梳理一下你的核心流程：

  1. 输入目的地 B（如老家所在站）
  2. 查询所有经过 B 站的车次（不仅是以 B 为终点的）
  3. 基于你当前所在城市 A，查询从 A
  出发，到这些车次的更远站点（终点或经停站）的余票情况，实现"买长乘短"

  在开始之前，我有几个问题想确认一下：

● User answered Claude's questions:
  ⎿  · 你希望用什么编程语言来开发这个工具？ → 我很想使用python，但是我的pyth
     on語法不是很熟悉，我目前對java比較熟悉一下

     · 你希望这个工具以什么形式呈现？ → 命令行工具 (推荐)
     · 关于数据来源，你倾向于哪种方式？ → 调用12306接口

● 好的！Java + 命令行 + 调用12306接口，这是一个明确且可行的方案。这个项目有一定
  复杂度，让我先做个设计规划。

● Entered plan mode
  Claude is now exploring and designing an implementation approach.

● 让我先看看当前项目目录的情况。

● Read 1 file (ctrl+o to expand)

● 目录是空的，这是一个全新项目。让我研究一下12306的API接口，然后设计项目方案。

● Explore(Research 12306 API endpoints)
  ⎿  Done (13 tool uses · 24.6k tokens · 1m 36s)

● 很好，我已经获得了12306 API的详细信息。现在让我设计项目方案。

● Updated plan
  ⎿  /plan to preview

● 方案已经设计完成。核心思路是：

  1. 查询 出发地A → 目的地B 的所有车次
  2. 对每个车次查询完整经停路线，找到 B 之后的延伸站点
  3. 查询 A → 延伸站点 的余票，发现"买长乘短"机会
  4. 以表格形式展示结果

● User approved Claude's plan
  ⎿  Plan saved to: 
     C:\Users\yuequanhuabai\.claude\plans\floofy-launching-creek.md · /plan 
     to edit

     12306 "买长乘短" 火车票查询工具 - 实现方案

     Context

     春运期间，中国大陆普通旅客很难买到热门区间的直达火车票。但如果购买同一
     车次更长区间（如买到终点站而非目的地站）的车票，往往更容易买到。本工具
     帮助用户：
     1. 查询经过目的地的所有车次
     2. 分析"买长乘短"的购票机会
     3. 展示从出发城市到各延伸站点的余票情况

     技术选型
     ┌─────────────┬─────────────────────┬────────────────────────┐
     │    项目     │        选择         │          理由          │
     ├─────────────┼─────────────────────┼────────────────────────┤
     │ 语言        │ Java 17+            │ 用户熟悉               │
     ├─────────────┼─────────────────────┼────────────────────────┤
     │ 构建工具    │ Maven               │ Java 标准构建工具      │
     ├─────────────┼─────────────────────┼────────────────────────┤
     │ HTTP 客户端 │ OkHttp 4.x          │ 简单易用，支持连接池   │
     ├─────────────┼─────────────────────┼────────────────────────┤
     │ JSON 解析   │ Gson                │ 轻量级，API 简洁       │
     ├─────────────┼─────────────────────┼────────────────────────┤
     │ CLI 交互    │ Scanner（标准输入） │ 简单直接，无需额外依赖 │
     └─────────────┴─────────────────────┴────────────────────────┘
     12306 关键 API

     1. 车站编码表

     GET https://kyfw.12306.cn/otn/resources/js/framework/station_name.js
     返回所有车站名称与编码的映射，格式: @bjb|北京北|VAP|beijingbei|bjb|0

     2. 余票查询

     GET https://kyfw.12306.cn/otn/leftTicket/queryX
     参数: leftTicketDTO.train_date, leftTicketDTO.from_station,
     leftTicketDTO.to_station, purpose_codes=ADULT
     注意：endpoint 后缀 (queryX/queryA/queryZ) 会变化，需要动态适配。

     3. 车次经停站查询

     GET https://kyfw.12306.cn/otn/czxx/queryByTrainNo
     参数: train_no, from_station_telecode, to_station_telecode, depart_date
     返回车次的全部经停站信息。

     HTTP 请求头要求

     User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) ...
     Referer: https://kyfw.12306.cn/otn
     Cookie: (从初始页面获取 JSESSIONID)

     项目结构

     ticket/
     ├── pom.xml
     └── src/main/java/com/ticket/
         ├── App.java                    # 主入口，CLI 交互
         ├── model/
         │   ├── Station.java            # 车站信息（名称、编码、拼音）
         │   ├── TrainInfo.java          #
     车次信息（车次号、出发/到达、座位余票）
         │   └── TrainStop.java          #
     经停站信息（站名、到达时间、出发时间）
         ├── service/
         │   ├── StationService.java     # 车站数据加载与查询
         │   ├── TicketQueryService.java # 余票查询
         │   └── TrainRouteService.java  # 车次路线查询
         └── util/
             └── HttpUtil.java           # HTTP 请求工具类

     核心流程

     用户交互流程

     1. 程序启动 → 加载车站编码数据
     2. 用户输入出发城市 A（如：深圳）
     3. 用户输入目的地 B（如：衡阳）
     4. 用户输入出行日期（如：2026-01-25）
     5. 程序执行查询 →
        a. 查询 A→B 的所有车次及余票
        b. 对于每个车次，查询其完整经停路线
        c. 找到 B 之后的所有站点 C1, C2, C3...
        d. 对于有延伸站点的车次，查询 A→C1, A→C2... 的余票
     6. 输出结果表格：
        ┌──────────┬────────┬────────┬──────────┬──────────────────────┐
        │ 车次     │ A→B    │ 二等座 │ 硬卧     │ 买长乘短机会          │
        ├──────────┼────────┼────────┼──────────┼──────────────────────┤
        │ G1234    │ 10:00  │ 无     │ --       │ A→C(终点): 有 (二等座)│
        │ K567     │ 12:30  │ --     │ 无       │ A→D: 3张 (硬卧)      │
        └──────────┴────────┴────────┴──────────┴──────────────────────┘

     关键逻辑

     StationService.java
     - 从12306下载 station_name.js 并解析为 Station 对象列表
     - 支持按中文名、拼音首字母模糊搜索车站
     - 首次加载后缓存到本地文件，避免重复下载

     TicketQueryService.java
     - 调用余票查询 API，解析返回的车次和余票数据
     - 处理 endpoint 变化（queryX/queryA 等）
     - 限速控制：请求间隔不少于 500ms，避免被封 IP

     TrainRouteService.java
     - 根据车次号查询完整经停路线
     - 识别目的地站在路线中的位置
     - 返回目的地之后的所有站点列表

     App.java - 核心流程
     1. 加载车站数据
     2. 获取用户输入（出发地A、目的地B、日期）
     3. 查询 A→B 余票 → 得到所有车次列表
     4. 遍历每个车次:
        4.1 查询该车次的完整经停路线
        4.2 找到 B 站之后的所有站点
        4.3 对每个后续站点 Cn，查询 A→Cn 的余票
        4.4 如果 A→Cn 有票而 A→B 无票，标记为"买长乘短"机会
     5. 汇总并输出结果

     实现步骤

     Step 1: 创建 Maven 项目骨架

     - 创建 pom.xml，引入 OkHttp、Gson 依赖
     - 创建目录结构

     Step 2: 实现 HttpUtil

     - 封装 OkHttp 请求，统一设置 Headers
     - 添加请求限速（500ms 间隔）
     - 处理 SSL 证书问题（12306 可能有自签名证书）

     Step 3: 实现 StationService

     - 下载并解析 station_name.js
     - 构建车站名称 → 编码的映射
     - 支持模糊搜索

     Step 4: 实现数据模型

     - Station, TrainInfo, TrainStop

     Step 5: 实现 TicketQueryService

     - 调用余票查询 API
     - 解析返回的票价和座位信息

     Step 6: 实现 TrainRouteService

     - 调用经停站查询 API
     - 解析完整路线

     Step 7: 实现 App 主流程

     - CLI 交互逻辑
     - 整合所有 Service
     - 输出格式化结果表格

     Step 8: 测试验证

     - 用实际站点测试完整流程
     - 验证"买长乘短"结果的正确性

     验证方式

     1. 运行 mvn package 确保编译通过
     2. 运行 java -jar ticket.jar
     3. 输入测试数据（如深圳→衡阳，选一个近期日期）
     4. 验证输出的车次信息与12306官网一致
     5. 验证"买长乘短"建议的合理性

     注意事项

     - 12306 API 为非官方接口，可能随时变化
     - 需要限制请求频率，避免 IP 被封
     - 本工具仅供个人查询分析使用
     - 12306 的 SSL 证书需要特殊处理（Java 的 TrustManager）


● 方案已批准，开始实现！让我先创建任务列表，然后逐步实现。

● 现在开始实现。

● Bash(mkdir -p "D:/software/develop_tools/git/gitee/ticket/src/main/java/com/ti
      cket/model" "D:/software/develop_tools/git/gitee/ticket/src/main/java/com/
      ticket/servic…)
  ⎿  (No content)

● Write(pom.xml)
  ⎿  Wrote 1 lines to pom.xml
       1 <?xml version="1.0" encoding="UTF-8"?>
       2 <project xmlns="http://maven.apache.org/POM/4.0.0"
       3          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       4          xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 h
         ttp://maven.apache.org/xsd/maven-4.0.0.xsd">
       5     <modelVersion>4.0.0</modelVersion>
       6 
       7     <groupId>com.ticket</groupId>
       8     <artifactId>ticket-query</artifactId>
       9     <version>1.0-SNAPSHOT</version>
      10     <packaging>jar</packaging>

● 现在同时实现 HttpUtil、数据模型和 StationService，它们之间相对独立。

● Write(src\main\java\com\ticket\util\HttpUtil.java)
  ⎿  Wrote 1 lines to src\main\java\com\ticket\util\HttpUtil.java
       1 package com.ticket.util;
       2 
       3 import okhttp3.OkHttpClient;
       4 import okhttp3.Request;
       5 import okhttp3.Response;
       6 
       7 import javax.net.ssl.SSLContext;
       8 import javax.net.ssl.TrustManager;
       9 import javax.net.ssl.X509TrustManager;
      10 import java.io.IOException;

● Write(src\main\java\com\ticket\model\Station.java)
  ⎿  Wrote 1 lines to src\main\java\com\ticket\model\Station.java
      1 package com.ticket.model;
      2 
      3 /**
      4  * 车站信息
      5  */
      6 public class Station {
      7 
      8     /** 车站简称（拼音首字母），如 bjb */
      9     private String abbr;

● Write(src\main\java\com\ticket\model\TrainInfo.java)
  ⎿  Wrote 1 lines to src\main\java\com\ticket\model\TrainInfo.java
      1 package com.ticket.model;
      2 
      3 /**
      4  * 车次信息及余票情况
      5  */
      6 public class TrainInfo {
      7 
      8     /** 车次内部编号（如 5l0000G10100） */
      9     private String trainNo;

● Write(src\main\java\com\ticket\model\TrainStop.java)
  ⎿  Wrote 1 lines to src\main\java\com\ticket\model\TrainStop.java
      1 package com.ticket.model;
      2 
      3 /**
      4  * 车次经停站信息
      5  */
      6 public class TrainStop {
      7 
      8     /** 站序（从1开始） */
      9     private int stationNo;

● 现在实现 StationService。

● Write(src\main\java\com\ticket\service\StationService.java)
  ⎿  Wrote 1 lines to src\main\java\com\ticket\service\StationService.java
       1 package com.ticket.service;
       2 
       3 import com.ticket.model.Station;
       4 import com.ticket.util.HttpUtil;
       5 
       6 import java.io.*;
       7 import java.nio.charset.StandardCharsets;
       8 import java.nio.file.Files;
       9 import java.nio.file.Path;
      10 import java.nio.file.Paths;

● 现在实现 TicketQueryService 和 TrainRouteService。

● Write(src\main\java\com\ticket\service\TicketQueryService.java)
  ⎿  Wrote 1 lines to
     src\main\java\com\ticket\service\TicketQueryService.java
      1 package com.ticket.service;
      2 
      3 import com.google.gson.JsonArray;
      4 import com.google.gson.JsonElement;
      5 import com.google.gson.JsonObject;
      6 import com.google.gson.JsonParser;
      7 import com.ticket.model.Station;
      8 import com.ticket.model.TrainInfo;
      9 import com.ticket.util.HttpUtil;

● Write(src\main\java\com\ticket\service\TrainRouteService.java)
  ⎿  Wrote 1 lines to
     src\main\java\com\ticket\service\TrainRouteService.java
       1 package com.ticket.service;
       2 
       3 import com.google.gson.JsonArray;
       4 import com.google.gson.JsonElement;
       5 import com.google.gson.JsonObject;
       6 import com.google.gson.JsonParser;
       7 import com.ticket.model.TrainStop;
       8 import com.ticket.util.HttpUtil;
       9 
      10 import java.io.IOException;

● 现在实现核心的 App 主程序。

● Write(src\main\java\com\ticket\App.java)
  ⎿  Wrote 1 lines to src\main\java\com\ticket\App.java
       1 package com.ticket;
       2 
       3 import com.ticket.model.Station;
       4 import com.ticket.model.TrainInfo;
       5 import com.ticket.model.TrainStop;
       6 import com.ticket.service.StationService;
       7 import com.ticket.service.TicketQueryService;
       8 import com.ticket.service.TrainRouteService;
       9 
      10 import java.util.List;

● 现在编译测试。

● Bash(cd "D:/software/develop_tools/git/gitee/ticket" && mvn compile 2>&1)
  ⎿ [INFO] Scanning for projects...
    [INFO]
    [INFO] ----------------------< com.ticket:ticket-query >---------------
    … +192 lines (ctrl+o to expand)


● 编译成功！现在打包。

● Bash(cd "D:/software/develop_tools/git/gitee/ticket" && mvn package -q 2>&1)
  ⎿  (No content)

● 打包成功！让我验证一下 JAR 文件。

● Read 1 file (ctrl+o to expand)

● 项目已完成编译打包！以下是项目总结：

  项目已就绪

  打包文件: target/ticket-query-1.0-SNAPSHOT.jar (约3.4MB，包含所有依赖)

  运行方式:
  cd D:/software/develop_tools/git/gitee/ticket
  java -jar target/ticket-query-1.0-SNAPSHOT.jar

  项目结构

  ticket/
  ├── pom.xml                                    # Maven 配置
  └── src/main/java/com/ticket/
      ├── App.java                               # 主入口 + CLI 交互
      ├── model/
      │   ├── Station.java                       # 车站模型
      │   ├── TrainInfo.java                     # 车次和余票模型
      │   └── TrainStop.java                     # 经停站模型
      ├── service/
      │   ├── StationService.java                # 车站数据加载与搜索
      │   ├── TicketQueryService.java            # 12306 余票查询
      │   └── TrainRouteService.java             # 车次经停站路线查询
      └── util/
          └── HttpUtil.java                      # HTTP
  请求工具（含限速和SSL处理）

  使用流程

  1. 启动程序 → 自动下载车站编码数据（首次，后续使用本地缓存）
  2. 输入出发城市（如 深圳）
  3. 输入目的地（如 衡阳）
  4. 输入出行日期（如 2026-02-10）
  5. 程序自动：
    - 查询直达余票
    - 对无票车次查询经停路线
    - 逐一查询延伸站点余票
    - 标记"买长乘短"机会（用 ★ 标识）

  你可以现在运行试试看！注意首次运行需要联网下载车站数据。

✻ Churned for 9m 56s

> 報錯了：                                                                  
                                                                            
  ----------------------------------------                                  
                                                                            
  请输入出发城市（如：深圳）（输入 q 退出）: 深圳                           
                                                                            
  &nbsp; -> 已选择: 深圳(SZQ)                                               
                                                                            
  请输入目的地（如：衡阳）（输入 q 退出）: 衡阳                             
                                                                            
  &nbsp; -> 已选择: 衡阳(HYQ)                                               
                                                                            
  请输入出行日期（格式 yyyy-MM-dd，如 2026-02-10）: 2026-02-13              
                                                                            
                                                                            
                                                                            
  正在查询 深圳 -> 衡阳 (2026-02-13) ...                                    
                                                                            
                                                                            
                                                                            
  【第1步】查询直达余票...                                                  
                                                                            
  解析余票数据失败: com.google.gson.stream.MalformedJsonException: Use      
  JsonReader.setStrictness(Strictness.LENIENT) to accept malformed JSON at  
  line 1 column 12 path $                                                   
                                                                            
  See https://github.com/google/gson/blob/main/Troubleshooting.md#malformed 
  -json                                                                     
                                                                            
  &nbsp; 未查询到从 深圳 到 衡阳 的车次。                                   
                                                                            
                                                                            
                                                                            
  是否继续查询？(y/n):                                                      
                                                                            

● 这个错误是因为 12306 API 返回的内容不是标准 JSON（可能是 endpoint
  已变更，返回了重定向页面）。让我修复这个问题。

● Read 1 file (ctrl+o to expand)

● 问题是 12306 的 API endpoint 后缀经常变化，queryX
  可能已经不是当前的了。我需要先获取正确的 endpoint，并增加重试和调试逻辑。

● Read 1 file (ctrl+o to expand)

● 需要做两个关键修复：
  1. HttpUtil 需要添加 Cookie 管理（12306 需要会话 Cookie）
  2. TicketQueryService 需要动态检测正确的 API endpoint

● Write(src\main\java\com\ticket\util\HttpUtil.java)
  ⎿  Added 67 lines, removed 6 lines
       1  package com.ticket.util;
       2  
       3 -import okhttp3.OkHttpClient;                                   
       4 -import okhttp3.Request;                                        
       5 -import okhttp3.Response;                                       
       3 +import okhttp3.*;                                              
       4  
       5  import javax.net.ssl.SSLContext;
       6  import javax.net.ssl.TrustManager;
       7  import javax.net.ssl.X509TrustManager;
       8  import java.io.IOException;
       9  import java.security.cert.X509Certificate;
      10 +import java.util.ArrayList;                                    
      11 +import java.util.HashMap;                                      
      12 +import java.util.List;                                         
      13 +import java.util.Map;                                          
      14  import java.util.concurrent.TimeUnit;
      15  
      16  public class HttpUtil {
     ...
      19      private static long lastRequestTime = 0;
      20      private static final long MIN_INTERVAL_MS = 500;
      21  
      22 +    /** 简单的内存 Cookie 存储 */                              
      23 +    private static final Map<String, List<Cookie>> COOKIE_STORE
         + = new HashMap<>();                                            
      24 +                                                               
      25      static {
      26 +        CookieJar cookieJar = new CookieJar() {                
      27 +            @Override                                          
      28 +            public void saveFromResponse(HttpUrl url, List<Cook
         +ie> cookies) {                                                 
      29 +                COOKIE_STORE.put(url.host(), cookies);         
      30 +            }                                                  
      31 +                                                               
      32 +            @Override                                          
      33 +            public List<Cookie> loadForRequest(HttpUrl url) {  
      34 +                List<Cookie> cookies = COOKIE_STORE.get(url.hos
         +t());                                                          
      35 +                return cookies != null ? cookies : new ArrayLis
         +t<>();                                                         
      36 +            }                                                  
      37 +        };                                                     
      38 +                                                               
      39          OkHttpClient.Builder builder = new OkHttpClient.Builder
          ()
      40 +                .cookieJar(cookieJar)                          
      41                  .connectTimeout(15, TimeUnit.SECONDS)
      42                  .readTimeout(15, TimeUnit.SECONDS)
      43                  .followRedirects(true);
      44  
      26 -        // 处理 SSL 证书（12306 可能有自签名证书问题）         
      45          try {
      46              X509TrustManager trustManager = new X509TrustManage
          r() {
      47                  @Override
     ...
      63      }
      64  
      65      /**
      66 +     * 初始化会话 - 先访问12306页面获取必要的Cookie            
      67 +     */                                                        
      68 +    public static void initSession() throws IOException {      
      69 +        throttle();                                            
      70 +        Request request = new Request.Builder()                
      71 +                .url("https://kyfw.12306.cn/otn/leftTicket/init
         +")                                                             
      72 +                .header("User-Agent", getUserAgent())          
      73 +                .header("Accept", "text/html,application/xhtml+
         +xml,application/xml;q=0.9,*/*;q=0.8")                          
      74 +                .header("Accept-Language", "zh-CN,zh;q=0.9")   
      75 +                .build();                                      
      76 +                                                               
      77 +        try (Response response = CLIENT.newCall(request).execut
         +e()) {                                                         
      78 +            // 只需要拿到 Cookie，内容不重要                   
      79 +            if (response.body() != null) {                     
      80 +                response.body().close();                       
      81 +            }                                                  
      82 +        }                                                      
      83 +    }                                                          
      84 +                                                               
      85 +    /**                                                        
      86       * 发送 GET 请求到 12306 API
      87       */
      88      public static String get(String url) throws IOException {
     ...
       90  
       91          Request request = new Request.Builder()
       92                  .url(url)
       55 -                .header("User-Agent", "Mozilla/5.0 (Windows NT
          - 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chro
          -me/120.0.0.0 Safari/537.36")                                  
       93 +                .header("User-Agent", getUserAgent())         
       94                  .header("Referer", "https://kyfw.12306.cn/otn/
           leftTicket/init")
       95                  .header("Accept", "application/json, text/java
           script, */*; q=0.01")
       96                  .header("Accept-Language", "zh-CN,zh;q=0.9")
       97 +                .header("X-Requested-With", "XMLHttpRequest") 
       98                  .header("Connection", "keep-alive")
       99                  .build();
      100  
     ...
      107      }
      108  
      109      /**
       71 -     * 限速控制，确保两次请求间隔不少于 MIN_INTERVAL_MS       
      110 +     * 发送 GET 请求并返回 HTML 内容（用于解析页面）          
      111       */
      112 +    public static String getHtml(String url) throws IOExceptio
          +n {                                                           
      113 +        throttle();                                           
      114 +                                                              
      115 +        Request request = new Request.Builder()               
      116 +                .url(url)                                     
      117 +                .header("User-Agent", getUserAgent())         
      118 +                .header("Accept", "text/html,application/xhtml
          ++xml,application/xml;q=0.9,*/*;q=0.8")                        
      119 +                .header("Accept-Language", "zh-CN,zh;q=0.9")  
      120 +                .build();                                     
      121 +                                                              
      122 +        try (Response response = CLIENT.newCall(request).execu
          +te()) {                                                       
      123 +            if (!response.isSuccessful()) {                   
      124 +                throw new IOException("请求失败, HTTP状态码: "
          + + response.code());                                          
      125 +            }                                                 
      126 +            return response.body() != null ? response.body().s
          +tring() : "";                                                 
      127 +        }                                                     
      128 +    }                                                         
      129 +                                                              
      130 +    private static String getUserAgent() {                    
      131 +        return "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Appl
          +eWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537
          +.36";                                                         
      132 +    }                                                         
      133 +                                                              
      134      private static synchronized void throttle() {
      135          long now = System.currentTimeMillis();
      136          long elapsed = now - lastRequestTime;

● Write(src\main\java\com\ticket\service\TicketQueryService.java)
  ⎿  Added 175 lines, removed 47 lines
      11  import java.io.IOException;
      12  import java.util.ArrayList;
      13  import java.util.List;
      14 +import java.util.regex.Matcher;                                
      15 +import java.util.regex.Pattern;                                
      16  
      17  /**
      18   * 余票查询服务
     ...
      20  public class TicketQueryService {
      21  
      22      private static final String BASE_URL = "https://kyfw.12306.
          cn/otn/leftTicket/";
      21 -    private String queryEndpoint = "queryX"; // 默认 endpoint，
         -可能会变                                                       
      23  
      24 +    /** 已知的 endpoint 后缀列表，12306 会不定期更换 */        
      25 +    private static final String[] KNOWN_ENDPOINTS = {          
      26 +            "query", "queryZ", "queryX", "queryA", "queryG", "q
         +ueryT",                                                        
      27 +            "queryO", "queryE", "queryD", "queryY"             
      28 +    };                                                         
      29 +                                                               
      30 +    private String queryEndpoint = null; // 动态检测           
      31      private final StationService stationService;
      32 +    private boolean sessionInitialized = false;                
      33  
      34      public TicketQueryService(StationService stationService) {
      35          this.stationService = stationService;
      36      }
      37  
      38      /**
      39 +     * 初始化：建立会话并检测正确的 API endpoint               
      40 +     */                                                        
      41 +    public void init() throws IOException {                    
      42 +        if (!sessionInitialized) {                             
      43 +            System.out.println("正在初始化12306会话...");      
      44 +            HttpUtil.initSession();                            
      45 +            sessionInitialized = true;                         
      46 +        }                                                      
      47 +                                                               
      48 +        if (queryEndpoint == null) {                           
      49 +            detectEndpoint();                                  
      50 +        }                                                      
      51 +    }                                                          
      52 +                                                               
      53 +    /**                                                        
      54 +     * 从 init 页面的 JS 中检测当前有效的查询 endpoint         
      55 +     */                                                        
      56 +    private void detectEndpoint() {                            
      57 +        try {                                                  
      58 +            System.out.println("正在检测余票查询接口...");     
      59 +            String html = HttpUtil.getHtml("https://kyfw.12306.
         +cn/otn/leftTicket/init");                                      
      60 +                                                               
      61 +            // 在页面 JS 中搜索类似 var CLeftTicketUrl = 'leftT
         +icket/queryX' 的模式                                           
      62 +            Pattern pattern = Pattern.compile("var\\s+CLeftTick
         +etUrl\\s*=\\s*'([^']+)'");                                     
      63 +            Matcher matcher = pattern.matcher(html);           
      64 +            if (matcher.find()) {                              
      65 +                String url = matcher.group(1);                 
      66 +                // url 可能是 "leftTicket/queryZ" 或直接是 "que
         +ryZ"                                                           
      67 +                if (url.contains("/")) {                       
      68 +                    queryEndpoint = url.substring(url.lastIndex
         +Of("/") + 1);                                                  
      69 +                } else {                                       
      70 +                    queryEndpoint = url;                       
      71 +                }                                              
      72 +                System.out.println("检测到查询接口: " + queryEn
         +dpoint);                                                       
      73 +                return;                                        
      74 +            }                                                  
      75 +        } catch (Exception e) {                                
      76 +            System.err.println("检测接口失败: " + e.getMessage(
         +));                                                            
      77 +        }                                                      
      78 +                                                               
      79 +        // 如果检测失败，使用默认值                            
      80 +        queryEndpoint = "query";                               
      81 +        System.out.println("使用默认查询接口: " + queryEndpoint
         +);                                                             
      82 +    }                                                          
      83 +                                                               
      84 +    /**                                                        
      85       * 查询两站之间的余票
      31 -     *                                                         
      32 -     * @param fromStationCode 出发站编码                       
      33 -     * @param toStationCode   到达站编码                       
      34 -     * @param date            出发日期 (yyyy-MM-dd)            
      35 -     * @return 车次列表                                        
      86       */
      87      public List<TrainInfo> queryTickets(String fromStationCode,
           String toStationCode, String date) throws IOException {
      88 +        // 确保已初始化                                        
      89 +        if (!sessionInitialized) {                             
      90 +            init();                                            
      91 +        }                                                      
      92 +                                                               
      93          String url = BASE_URL + queryEndpoint
      94                  + "?leftTicketDTO.train_date=" + date
      95                  + "&leftTicketDTO.from_station=" + fromStationC
          ode
     ...
       97                  + "&purpose_codes=ADULT";
       98  
       99          String response = HttpUtil.get(url);
       45 -        return parseResponse(response);                       
      100 +                                                              
      101 +        // 检查是否返回了非 JSON 内容（如 HTML 错误页面）     
      102 +        String trimmed = response.trim();                     
      103 +        if (trimmed.isEmpty()) {                              
      104 +            System.err.println("API 返回空响应");             
      105 +            return new ArrayList<>();                         
      106 +        }                                                     
      107 +                                                              
      108 +        if (!trimmed.startsWith("{")) {                       
      109 +            // 不是 JSON，可能 endpoint 已变更，尝试其他 endpo
          +int                                                           
      110 +            System.err.println("当前接口(" + queryEndpoint + "
          +)返回非JSON响应，正在尝试其他接口...");                       
      111 +            return retryWithOtherEndpoints(fromStationCode, to
          +StationCode, date);                                           
      112 +        }                                                     
      113 +                                                              
      114 +        List<TrainInfo> result = parseResponse(response);     
      115 +                                                              
      116 +        // 如果解析结果为空且 response 包含 c_url，说明 endpoi
          +nt 需要更新                                                   
      117 +        if (result.isEmpty() && response.contains("c_url")) { 
      118 +            try {                                             
      119 +                JsonObject root = JsonParser.parseString(respo
          +nse).getAsJsonObject();                                       
      120 +                if (root.has("c_url")) {                      
      121 +                    String newUrl = root.get("c_url").getAsStr
          +ing();                                                        
      122 +                    if (newUrl != null && !newUrl.isEmpty()) {
      123 +                        if (newUrl.contains("/")) {           
      124 +                            queryEndpoint = newUrl.substring(n
          +ewUrl.lastIndexOf("/") + 1);                                  
      125 +                        } else {                              
      126 +                            queryEndpoint = newUrl;           
      127 +                        }                                     
      128 +                        System.out.println("接口已更新为: " + 
          +queryEndpoint + "，正在重新查询...");                         
      129 +                        return queryTickets(fromStationCode, t
          +oStationCode, date);                                          
      130 +                    }                                         
      131 +                }                                             
      132 +            } catch (Exception ignored) {}                    
      133 +        }                                                     
      134 +                                                              
      135 +        return result;                                        
      136      }
      137  
      138      /**
      139 +     * 依次尝试已知的 endpoint 后缀                           
      140 +     */                                                       
      141 +    private List<TrainInfo> retryWithOtherEndpoints(String fro
          +mStationCode, String toStationCode, String date) {            
      142 +        for (String endpoint : KNOWN_ENDPOINTS) {             
      143 +            if (endpoint.equals(queryEndpoint)) continue; //  
          +跳过已失败的                                                  
      144 +                                                              
      145 +            try {                                             
      146 +                String url = BASE_URL + endpoint              
      147 +                        + "?leftTicketDTO.train_date=" + date 
      148 +                        + "&leftTicketDTO.from_station=" + fro
          +mStationCode                                                  
      149 +                        + "&leftTicketDTO.to_station=" + toSta
          +tionCode                                                      
      150 +                        + "&purpose_codes=ADULT";             
      151 +                                                              
      152 +                String response = HttpUtil.get(url);          
      153 +                String trimmed = response.trim();             
      154 +                                                              
      155 +                if (!trimmed.isEmpty() && trimmed.startsWith("
          +{")) {                                                        
      156 +                    List<TrainInfo> result = parseResponse(res
          +ponse);                                                       
      157 +                    if (!result.isEmpty()) {                  
      158 +                        queryEndpoint = endpoint;             
      159 +                        System.out.println("找到有效接口: " + 
          +endpoint);                                                    
      160 +                        return result;                        
      161 +                    }                                         
      162 +                    // 即使结果为空但 JSON 格式正确，也记住这 
          +个 endpoint                                                   
      163 +                    if (trimmed.contains("\"data\"")) {       
      164 +                        queryEndpoint = endpoint;             
      165 +                        System.out.println("找到有效接口: " + 
          +endpoint + "（当前无车次数据）");                             
      166 +                        return result;                        
      167 +                    }                                         
      168 +                }                                             
      169 +            } catch (Exception e) {                           
      170 +                // 继续尝试下一个                             
      171 +            }                                                 
      172 +        }                                                     
      173 +                                                              
      174 +        System.err.println("所有已知接口均无法获取数据，12306 
          +可能已更新接口。");                                           
      175 +        return new ArrayList<>();                             
      176 +    }                                                         
      177 +                                                              
      178 +    /**                                                       
      179       * 解析 12306 余票查询响应
      180       */
      181      private List<TrainInfo> parseResponse(String response) {
     ...
      184          try {
      185              JsonObject root = JsonParser.parseString(response)
           .getAsJsonObject();
      186  
       57 -            // 检查是否需要更新 endpoint                      
       58 -            if (root.has("c_url")) {                          
       59 -                String newUrl = root.get("c_url").getAsString(
          -);                                                            
       60 -                if (newUrl != null && !newUrl.isEmpty()) {    
       61 -                    queryEndpoint = newUrl;                   
       62 -                    System.out.println("API endpoint 已更新为:
          - " + queryEndpoint);                                          
      187 +            // 检查是否有错误信息                             
      188 +            if (root.has("status") && !root.get("status").getA
          +sBoolean()) {                                                 
      189 +                if (root.has("messages") && root.getAsJsonArra
          +y("messages").size() > 0) {                                   
      190 +                    System.err.println("12306 返回错误: " + ro
          +ot.getAsJsonArray("messages"));                               
      191                  }
      192 +                return trains;                                
      193              }
      194  
      195              if (!root.has("data")) {
       67 -                System.err.println("响应中无 data 字段");     
      196                  return trains;
      197              }
      198  
       71 -            JsonObject data = root.getAsJsonObject("data");   
      199 +            JsonElement dataElement = root.get("data");       
      200 +            if (!dataElement.isJsonObject()) {                
      201 +                return trains;                                
      202 +            }                                                 
      203 +                                                              
      204 +            JsonObject data = dataElement.getAsJsonObject();  
      205              if (!data.has("result")) {
       73 -                System.err.println("响应中无 result 字段");   
      206                  return trains;
      207              }
      208  
       77 -            // 获取车站编码映射                               
      209              JsonObject stationMap = data.has("map") ? data.get
           AsJsonObject("map") : null;
      210  
      211              JsonArray results = data.getAsJsonArray("result");
     ...
      218              }
      219          } catch (Exception e) {
      220              System.err.println("解析余票数据失败: " + e.getMes
           sage());
      221 +            // 打印前200个字符帮助调试                        
      222 +            if (response.length() > 200) {                    
      223 +                System.err.println("响应内容(前200字符): " + r
          +esponse.substring(0, 200));                                   
      224 +            } else {                                          
      225 +                System.err.println("响应内容: " + response);  
      226 +            }                                                 
      227          }
      228  
      229          return trains;
     ...
      231  
      232      /**
      233       * 解析单条车次数据
       97 -     * 12306 返回的数据以 | 分隔，各字段有固定位置            
      234       */
      235      private TrainInfo parseTrainData(String rawData, JsonObjec
           t stationMap) {
      236          try {
     ...
      239  
      240              TrainInfo train = new TrainInfo();
      241              train.setRawData(rawData);
      106 -            train.setTrainNo(fields[2]);               // 车次
          -内部编号                                                      
      107 -            train.setStationTrainCode(fields[3]);       // 车 
          -次代码 (如 G101)                                              
      108 -            train.setFromStationCode(fields[6]);        // 出 
          -发站编码                                                      
      109 -            train.setToStationCode(fields[7]);          // 到 
          -达站编码                                                      
      110 -            train.setStartTime(fields[8]);              // 出 
          -发时间                                                        
      111 -            train.setArriveTime(fields[9]);             // 到 
          -达时间                                                        
      112 -            train.setDuration(fields[10]);              // 历 
          -时                                                            
      242 +            train.setTrainNo(fields[2]);                      
      243 +            train.setStationTrainCode(fields[3]);             
      244 +            train.setFromStationCode(fields[6]);              
      245 +            train.setToStationCode(fields[7]);                
      246 +            train.setStartTime(fields[8]);                    
      247 +            train.setArriveTime(fields[9]);                   
      248 +            train.setDuration(fields[10]);                    
      249  
      114 -            // 从 map 中获取站名                              
      250              if (stationMap != null) {
      116 -                String fromCode = fields[6];                  
      117 -                String toCode = fields[7];                    
      118 -                if (stationMap.has(fromCode)) {               
      119 -                    train.setFromStationName(stationMap.get(fr
          -omCode).getAsString());                                       
      251 +                if (stationMap.has(fields[6])) {              
      252 +                    train.setFromStationName(stationMap.get(fi
          +elds[6]).getAsString());                                      
      253                  }
      121 -                if (stationMap.has(toCode)) {                 
      122 -                    train.setToStationName(stationMap.get(toCo
          -de).getAsString());                                           
      254 +                if (stationMap.has(fields[7])) {              
      255 +                    train.setToStationName(stationMap.get(fiel
          +ds[7]).getAsString());                                        
      256                  }
      257              }
      258  
      126 -            // 始发站和终到站                                 
      259              train.setStartStationName(fields[4]);
      260              train.setEndStationName(fields[5]);
      261  
      130 -            // 如果 map 中没有站名，尝试从 stationService 获取
      262              if (train.getFromStationName() == null) {
      263                  Station s = stationService.getByCode(fields[6]
           );
      264                  train.setFromStationName(s != null ? s.getName
           () : fields[6]);
     ...
      268                  train.setToStationName(s != null ? s.getName()
            : fields[7]);
      269              }
      270  
      140 -            // 解析余票信息                                   
      141 -            train.setBusinessSeat(getField(fields, 32));      
          - // 商务座/特等座                                             
      142 -            train.setFirstClassSeat(getField(fields, 31));    
          - // 一等座                                                    
      143 -            train.setSecondClassSeat(getField(fields, 30));   
          - // 二等座                                                    
      144 -            train.setAdvancedSoftSleeper(getField(fields, 21))
          -; // 高级软卧                                                 
      145 -            train.setSoftSleeper(getField(fields, 23));       
          - // 软卧                                                      
      146 -            train.setMoveSleeper(getField(fields, 33));       
          - // 动卧                                                      
      147 -            train.setHardSleeper(getField(fields, 28));       
          - // 硬卧                                                      
      148 -            train.setSoftSeat(getField(fields, 24));          
          - // 软座                                                      
      149 -            train.setHardSeat(getField(fields, 29));          
          - // 硬座                                                      
      150 -            train.setNoSeat(getField(fields, 26));            
          - // 无座                                                      
      151 -                                                              
      152 -            // 是否可预订                                     
      271 +            train.setBusinessSeat(getField(fields, 32));      
      272 +            train.setFirstClassSeat(getField(fields, 31));    
      273 +            train.setSecondClassSeat(getField(fields, 30));   
      274 +            train.setAdvancedSoftSleeper(getField(fields, 21))
          +;                                                             
      275 +            train.setSoftSleeper(getField(fields, 23));       
      276 +            train.setMoveSleeper(getField(fields, 33));       
      277 +            train.setHardSleeper(getField(fields, 28));       
      278 +            train.setSoftSeat(getField(fields, 24));          
      279 +            train.setHardSeat(getField(fields, 29));          
      280 +            train.setNoSeat(getField(fields, 26));            
      281              train.setCanBook("Y".equals(fields[11]));
      282  
      283              return train;

● 现在更新 App.java，在启动时调用 init()。

● Read 1 file (ctrl+o to expand)

● Update(src\main\java\com\ticket\App.java)
  ⎿  Added 3 lines, removed 2 lines
      33          System.out.println("===================================
          =====");
      34          System.out.println();
      35  
      36 -        // 1. 初始化车站数据                                   
      36 +        // 1. 初始化车站数据和12306会话                        
      37          try {
      38              stationService.init();
      39 +            ticketQueryService.init();                         
      40          } catch (Exception e) {
      40 -            System.err.println("初始化车站数据失败: " + e.getMe
         -ssage());                                                      
      41 +            System.err.println("初始化失败: " + e.getMessage())
         +;                                                              
      42              System.err.println("请检查网络连接后重试。");
      43              return;
      44          }

● 重新编译打包。

● Bash(cd "D:/software/develop_tools/git/gitee/ticket" && mvn package -q 2>&1)
  ⎿  (No content)

● 编译打包成功！主要修复了以下3个问题：

  1. 添加 Cookie 管理 — HttpUtil 现在使用 CookieJar 自动保存和发送 12306 的会话
  Cookie
  2. 动态检测 API endpoint — 程序启动时会访问 12306 的 init 页面，从 JS
  中提取当前有效的查询接口（CLeftTicketUrl 变量）
  3. endpoint 自动重试 — 如果检测失败或返回非 JSON 内容，会依次尝试 query,
  queryZ, queryX, queryA 等已知后缀，直到找到有效接口

  你可以重新运行试试：
  java -jar target/ticket-query-1.0-SNAPSHOT.jar

✻ Sautéed for 2m 6s

> ----------------------------------------                                  
                                                                            
  请输入出发城市（如：深圳）（输入 q 退出）: 深圳                           
                                                                            
  &nbsp; -> 已选择: 深圳(SZQ)                                               
                                                                            
  请输入目的地（如：衡阳）（输入 q 退出）: 衡阳                             
                                                                            
  &nbsp; -> 已选择: 衡阳(HYQ)                                               
                                                                            
  请输入出行日期（格式 yyyy-MM-dd，如 2026-02-10）: 2026-02-13              
                                                                            
                                                                            
                                                                            
  正在查询 深圳 -> 衡阳 (2026-02-13) ...                                    
                                                                            
                                                                            
                                                                            
  【第1步】查询直达余票...                                                  
                                                                            
  &nbsp; 共找到 81 个车次                                                   
                                                                            
                                                                            
                                                                            
  车次       出发站        到达站        出发       到达     历时           
  商务座      一等座      二等座      硬卧       硬座                       
                                                                            
  ───────────────────────────────────────────────────────────────────────── 
  ─────────────────────────────────────                                     
                                                                            
  G9690    深圳北        衡阳东        00:21    02:49  02:28    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  K4426    深圳东        衡阳         00:43    08:03  07:20    --       --  
        --       无        无                                               
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 目的地之后还有 8 个站，正在逐一查询余票...                     
                                                                            
  G9782    福田         衡阳东        01:51    04:43  02:52    无        无 
          无        --       --                                             
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G9764    深圳北        衡阳东        01:52    04:20  02:28    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G9766    福田         衡阳东        02:10    05:00  02:50    无        无 
          无        --       --                                             
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G9758    深圳北        衡阳东        02:40    05:24  02:44    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G9696    福田         衡阳东        02:41    05:05  02:24    无        无 
          无        --       --                                             
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G9748    福田         衡阳东        03:00    05:28  02:28    无        无 
          无        --       --                                             
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G9744    福田         衡阳东        03:52    06:41  02:49    无        无 
          无        --       --                                             
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G9668    深圳北        衡阳东        05:09    07:26  02:17    --       无 
          无        --       --                                             
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G1102    深圳北        衡阳东        06:08    08:40  02:32    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G1002    深圳北        衡阳东        06:33    09:14  02:41    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  K6572    深圳         衡阳         06:40    15:30  08:50    --       --   
       --       无        无                                                
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G6058    深圳北        衡阳东        06:47    09:33  02:46    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  Z332     深圳东        衡阳         07:06    14:30  07:24    --       --  
        --       无        无                                               
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 目的地之后还有 6 个站，正在逐一查询余票...                     
                                                                            
  G6072    福田         衡阳东        07:18    10:32  03:14    无        无 
          无        --       --                                             
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G6090    深圳北        衡阳东        07:27    10:23  02:56    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G388     福田         衡阳东        07:36    10:07  02:31    无        无 
          无        --       --                                             
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G388     深圳北        衡阳东        07:50    10:07  02:17    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  K1348    深圳         衡阳         08:00    15:53  07:53    --       --   
       --       无        无                                                
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 目的地之后还有 13 个站，正在逐一查询余票...                    
                                                                            
  G4238    深圳北        衡阳东        08:04    10:40  02:36    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G1004    深圳北        衡阳东        08:12    10:50  02:38    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G2138    深圳北        衡阳东        08:17    10:55  02:38    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G6080    深圳北        衡阳东        08:33    11:07  02:34    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G6034    深圳北        衡阳东        08:52    11:44  02:52    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G914     福田         衡阳东        09:18    12:30  03:12    无        无 
          无        --       --                                             
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  Z230     深圳东        衡阳         09:33    16:33  07:00    --       --  
        --       无        无                                               
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 目的地之后还有 11 个站，正在逐一查询余票...                    
                                                                            
  G914     深圳北        衡阳东        09:34    12:30  02:56    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G904     深圳北        衡阳东        09:41    12:38  02:57    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  K486     深圳         衡阳         09:50    17:23  07:33    --       --   
       --       无        无                                                
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 目的地之后还有 12 个站，正在逐一查询余票...                    
                                                                            
  &nbsp;   ★ 买长乘短机会! 深圳 → 广安南(K486): 无座:2                      
                                                                            
  G6004    深圳北        衡阳东        10:00    12:14  02:14    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G390     深圳北        衡阳东        10:10    12:18  02:08    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G408     深圳北        衡阳东        10:13    12:22  02:09    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G1040    深圳北        衡阳东        10:23    12:51  02:28    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G1152    深圳北        衡阳东        10:39    13:23  02:44    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G6126    深圳北        衡阳东        10:43    13:19  02:36    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  K6640    深圳         衡阳         10:45    18:10  07:25    --       --   
       --       无        无                                                
                                                                            
  K356     深圳东        衡阳         11:34    19:39  08:05    --       --  
        --       无        无                                               
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 目的地之后还有 8 个站，正在逐一查询余票...                     
                                                                            
  K932     深圳东        衡阳         11:49    19:12  07:23    --       --  
        --       无        无                                               
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 目的地之后还有 4 个站，正在逐一查询余票...                     
                                                                            
  G1006    深圳北        衡阳东        12:00    14:55  02:55    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G1176    深圳北        衡阳东        12:07    15:05  02:58    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G830     深圳北        衡阳东        12:43    15:23  02:40    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G1028    深圳北        衡阳东        12:47    15:27  02:40    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G1008    深圳北        衡阳东        13:09    16:02  02:53    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G6030    深圳北        衡阳东        13:17    15:57  02:40    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  K1656    深圳东        衡阳         13:31    21:10  07:39    --       --  
        --       无        无                                               
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 目的地之后还有 8 个站，正在逐一查询余票...                     
                                                                            
  G6022    深圳北        衡阳东        13:41    16:27  02:46    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G6028    深圳北        衡阳东        13:51    16:42  02:51    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 未能获取经停站信息                                             
                                                                            
  C7268    福田         衡阳东        14:05    17:21  03:16    无        无 
          无        --       --                                             
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  C7268    深圳北        衡阳东        14:16    17:21  03:05    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G6062    深圳北        衡阳东        14:21    16:56  02:35    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G386     深圳北        衡阳东        14:27    16:37  02:10    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G1032    深圳北        衡阳东        14:50    17:27  02:37    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G6076    深圳北        衡阳东        15:07    18:11  03:04    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  K238     深圳东        衡阳         15:28    23:10  07:42    --       --  
        --       无        无                                               
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 目的地之后还有 28 个站，正在逐一查询余票...                    
                                                                            
  G1190    深圳北        衡阳东        15:44    18:23  02:39    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G1010    深圳北        衡阳东        16:02    19:01  02:59    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G6068    深圳北        衡阳东        16:13    18:47  02:34    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G1192    深圳北        衡阳东        16:17    18:55  02:38    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  K536     深圳         衡阳         16:18    00:08  07:50    --       --   
       --       无        无                                                
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 目的地之后还有 12 个站，正在逐一查询余票...                    
                                                                            
  &nbsp;   ★ 买长乘短机会! 深圳 → 长沙(K536): 无座:1                        
                                                                            
  G400     深圳北        衡阳东        16:46    19:12  02:26    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G420     深圳北        衡阳东        16:50    19:16  02:26    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G1012    深圳北        衡阳东        17:08    19:42  02:34    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  T96      深圳东        衡阳         17:30    00:57  07:27    --       --  
        --       无        无                                               
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 目的地之后还有 2 个站，正在逐一查询余票...                     
                                                                            
  G6114    深圳北        衡阳东        17:39    20:03  02:24    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G6130    深圳北        衡阳东        18:22    21:10  02:48    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G6014    深圳北        衡阳东        18:42    21:05  02:23    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  G4750    深圳北        衡阳东        19:08    21:54  02:46    无          
  无        无        --       --                                           
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 衡阳 已是该车次的终到站，无延伸站点                            
                                                                            
  K9260    深圳东        衡阳         19:50    02:59  07:09    --       --  
        --       无        无                                               
                                                                            
  &nbsp;   ? 正在查询该车次的延伸站点...                                    
                                                                            
  &nbsp;   ? 目的地之后还有 11 个站，正在逐一查询余票...                    
                                                                            
  当前接口(queryG)返回非JSON响应，正在尝试其他接口...                       
                                                                            
  找到有效接口: queryX                                                      
                                                                            
  当前接口(queryX)返回非JSON响应，正在尝试其他接口...                       
                                                                            
  所有已知接口均无法获取数据，12306 可能已更新接口。                        
                                                                            
  当前接口(queryX)返回非JSON响应，正在尝试其他接口...                       
                                                                            
  所有已知接口均无法获取数据，12306 可能已更新接口。                        
                                                                            
  当前接口(queryX)返回非JSON响应，正在尝试其他接口...                       
                                                                            
  找到有效接口: queryG                                                      
                                                                            
  当前接口(queryG)返回非JSON响应，正在尝试其他接口...                       
                                                                            
  所有已知接口均无法获取数据，12306 可能已更新接口。                        
                                                                            
  当前接口(queryG)返回非JSON响应，正在尝试其他接口...                       
                                                                            
  Disconnected from the target VM, address: '127.0.0.1:9688', transport:    
  'socket'                                                                  
                                                                            

● 程序已经能工作了！找到了2个"买长乘短"机会（K486 和
  K536）。但我注意到几个需要修复的问题：

  1. 路线查询范围不完整 — 查询经停站时传的是查询区间（A→B），导致只返回 A 到 B
  的站点，看不到 B 之后的站。应该用车次的实际始发站→终到站来查完整路线。
  2. 站名匹配问题 — "衡阳" vs "衡阳东"
  不匹配，导致很多本应有延伸站的车次误判为"终到站"。
  3. 频繁请求被限流 — 查询太多导致 12306 开始拒绝，需要增加请求间隔。

  让我修复这些问题。

● Read 1 file (ctrl+o to expand)

● Now I see the core problems clearly. Let me fix them all.

● Read 2 files (ctrl+o to expand)

● 现在我看清了问题所在。12306 API 返回的 fields[4] 和 fields[5]
  是始发站/终到站的电报码（不是站名），而查询经停站时只传了查询区间的
  from/to，导致拿不到完整路线。让我做全面修复。

  修复 1: TrainInfo 增加始发站/终到站编码字段

● Update(src\main\java\com\ticket\model\TrainInfo.java)
  ⎿  Added 6 lines
      11      /** 车次代码（如 G101） */
      12      private String stationTrainCode;
      13  
      14 +    /** 始发站电报码 */                                        
      15 +    private String startStationCode;                           
      16 +                                                               
      17 +    /** 终到站电报码 */                                        
      18 +    private String endStationCode;                             
      19 +                                                               
      20      /** 始发站名 */
      21      private String startStationName;
      22  

● Read 1 file (ctrl+o to expand)

● Update(src\main\java\com\ticket\model\TrainInfo.java)
  ⎿  Added 6 lines
      86      public String getStationTrainCode() { return stationTrainCo
          de; }
      87      public void setStationTrainCode(String stationTrainCode) { 
          this.stationTrainCode = stationTrainCode; }
      88  
      89 +    public String getStartStationCode() { return startStationCo
         +de; }                                                          
      90 +    public void setStartStationCode(String startStationCode) { 
         +this.startStationCode = startStationCode; }                    
      91 +                                                               
      92 +    public String getEndStationCode() { return endStationCode; 
         +}                                                              
      93 +    public void setEndStationCode(String endStationCode) { this
         +.endStationCode = endStationCode; }                            
      94 +                                                               
      95      public String getStartStationName() { return startStationNa
          me; }
      96      public void setStartStationName(String startStationName) { 
          this.startStationName = startStationName; }
      97  

● 修复 2: TicketQueryService 正确解析始发站/终到站编码

● Read 1 file (ctrl+o to expand)

● Update(src\main\java\com\ticket\service\TicketQueryService.java)
  ⎿  Added 9 lines, removed 2 lines
      256                  }
      257              }
      258  
      259 -            train.setStartStationName(fields[4]);             
      260 -            train.setEndStationName(fields[5]);               
      259 +            // fields[4] 和 fields[5] 是始发站和终到站的电报码
      260 +            train.setStartStationCode(fields[4]);             
      261 +            train.setEndStationCode(fields[5]);               
      262  
      263 +            // 从 stationService 解析始发站/终到站名称        
      264 +            Station startStation = stationService.getByCode(fi
          +elds[4]);                                                     
      265 +            train.setStartStationName(startStation != null ? s
          +tartStation.getName() : fields[4]);                           
      266 +            Station endStation = stationService.getByCode(fiel
          +ds[5]);                                                       
      267 +            train.setEndStationName(endStation != null ? endSt
          +ation.getName() : fields[5]);                                 
      268 +                                                              
      269              if (train.getFromStationName() == null) {
      270                  Station s = stationService.getByCode(fields[6]
           );
      271                  train.setFromStationName(s != null ? s.getName
           () : fields[6]);

● 修复 3: TrainRouteService — 用站点编码匹配（不再仅靠站名）

● Update(src\main\java\com\ticket\service\TrainRouteService.java)
  ⎿  Added 12 lines, removed 3 lines
       86  
       87      /**
       88       * 在经停站列表中找到指定站点之后的所有站点
       89 +     * 支持按站名或站点编码匹配                               
       90       *
       91       * @param stops       完整经停站列表
       92       * @param stationName 目标站名
       93 +     * @param stationCode 目标站编码（电报码），可为 null     
       94       * @return 目标站之后的站点列表（不含目标站本身）
       95       */
       94 -    public List<TrainStop> getStopsAfter(List<TrainStop> stops
          -, String stationName) {                                       
       96 +    public List<TrainStop> getStopsAfter(List<TrainStop> stops
          +, String stationName, String stationCode) {                   
       97          List<TrainStop> result = new ArrayList<>();
       98          boolean found = false;
       99          for (TrainStop stop : stops) {
      100              if (found) {
      101                  result.add(stop);
      102              }
      101 -            if (stop.getStationName().equals(stationName)) {  
      102 -                found = true;                                 
      103 +            // 先按编码匹配，再按站名匹配（包含匹配，如"衡阳" 
          +匹配"衡阳东"）                                                
      104 +            if (!found) {                                     
      105 +                if (stationCode != null && stationCode.equals(
          +stop.getStationCode())) {                                     
      106 +                    found = true;                             
      107 +                } else if (stop.getStationName().equals(statio
          +nName)                                                        
      108 +                        || stop.getStationName().startsWith(st
          +ationName)                                                    
      109 +                        || stationName.startsWith(stop.getStat
          +ionName())) {                                                 
      110 +                    found = true;                             
      111 +                }                                             
      112              }
      113          }
      114          return result;

● 修复 4: App.java 核心逻辑 —
  用始发/终到站查完整路线，跳过真正的终到站车次，增加限流

● Update(src\main\java\com\ticket\App.java)
  ⎿  Added 129 lines, removed 61 lines
      160          System.out.println("  共找到 " + directTrains.size() +
            " 个车次");
      161          System.out.println();
      162  
      163 -        // 打印直达余票表头                                   
      163 +        // 先打印所有车次的余票概况                           
      164          printTableHeader();
      165 -                                                              
      165          int noTicketCount = 0;
      166 +        int hasTicketCount = 0;                               
      167 +        int canExtendCount = 0;                               
      168 +                                                              
      169 +        for (TrainInfo train : directTrains) {                
      170 +            printTrainRow(train);                             
      171 +            if (train.hasAvailableTicket()) {                 
      172 +                hasTicketCount++;                             
      173 +            } else {                                          
      174 +                noTicketCount++;                              
      175 +                // 判断该车次是否有延伸空间（到达站编码 != 终 
          +到站编码）                                                    
      176 +                if (!train.getToStationCode().equals(train.get
          +EndStationCode())) {                                          
      177 +                    canExtendCount++;                         
      178 +                }                                             
      179 +            }                                                 
      180 +        }                                                     
      181 +                                                              
      182 +        System.out.println();                                 
      183 +        System.out.println("直达有票: " + hasTicketCount + " |
          + 直达无票: " + noTicketCount                                  
      184 +                + " | 可尝试买长: " + canExtendCount);        
      185 +                                                              
      186 +        if (canExtendCount == 0) {                            
      187 +            System.out.println("所有无票车次均以目的地为终到站
          +，无法使用买长乘短策略。");                                   
      188 +            printSummary(directTrains.size(), hasTicketCount, 
          +noTicketCount, 0);                                            
      189 +            return;                                           
      190 +        }                                                     
      191 +                                                              
      192 +        // Step 2: 对可延伸的无票车次，分析"买长乘短"机会     
      193 +        System.out.println();                                 
      194 +        System.out.println("【第2步】分析买长乘短机会（共 " + 
          +canExtendCount + " 个车次需要查询）...");                     
      195 +        System.out.println();                                 
      196 +                                                              
      197          int buyLongOpportunities = 0;
      198 +        int analyzed = 0;                                     
      199  
      200          for (TrainInfo train : directTrains) {
      170 -            // 打印直达余票信息                               
      171 -            printTrainRow(train, fromStation.getName(), toStat
          -ion.getName());                                               
      201 +            // 只分析无票且有延伸空间的车次                   
      202 +            if (train.hasAvailableTicket()) continue;         
      203 +            if (train.getToStationCode().equals(train.getEndSt
          +ationCode())) continue;                                       
      204  
      173 -            // Step 2: 对于无票或票少的车次，分析"买长乘短"机 
          -会                                                            
      174 -            if (!train.hasAvailableTicket()) {                
      175 -                noTicketCount++;                              
      205 +            analyzed++;                                       
      206 +            System.out.println("[" + analyzed + "/" + canExten
          +dCount + "] "                                                 
      207 +                    + train.getStationTrainCode()             
      208 +                    + " (" + train.getFromStationName() + "→" 
          ++ train.getToStationName()                                    
      209 +                    + ", 终到: " + train.getEndStationName() +
          + ")");                                                        
      210  
      177 -                System.out.println("    ↳ 正在查询该车次的延伸
          -站点...");                                                    
      211 +            try {                                             
      212 +                // 关键修复：用车次的实际始发站→终到站查完整路
          +线                                                            
      213 +                List<TrainStop> route = trainRouteService.quer
          +yRoute(                                                       
      214 +                        train.getTrainNo(),                   
      215 +                        train.getStartStationCode(),          
      216 +                        train.getEndStationCode(),            
      217 +                        date);                                
      218  
      179 -                try {                                         
      180 -                    List<TrainStop> route = trainRouteService.
          -queryRoute(                                                   
      181 -                            train.getTrainNo(),               
      182 -                            train.getFromStationCode(),       
      183 -                            train.getToStationCode(),         
      184 -                            date);                            
      219 +                if (route.isEmpty()) {                        
      220 +                    System.out.println("    ↳ 未能获取经停站信
          +息");                                                         
      221 +                    continue;                                 
      222 +                }                                             
      223  
      186 -                    if (route.isEmpty()) {                    
      187 -                        System.out.println("    ↳ 未能获取经停
          -站信息");                                                     
      188 -                        continue;                             
      189 -                    }                                         
      224 +                // 用到达站编码在完整路线中定位，找到之后的站 
          +点                                                            
      225 +                List<TrainStop> stopsAfter = trainRouteService
          +.getStopsAfter(                                               
      226 +                        route, toStation.getName(), train.getT
          +oStationCode());                                              
      227  
      191 -                    // 找到目的地之后的站点                   
      192 -                    List<TrainStop> stopsAfter = trainRouteSer
          -vice.getStopsAfter(route, toStation.getName());               
      228 +                if (stopsAfter.isEmpty()) {                   
      229 +                    System.out.println("    ↳ 目的地之后无更多
          +站点");                                                       
      230 +                    continue;                                 
      231 +                }                                             
      232  
      194 -                    if (stopsAfter.isEmpty()) {               
      195 -                        System.out.println("    ↳ " + toStatio
          -n.getName() + " 已是该车次的终到站，无延伸站点");             
      196 -                        continue;                             
      197 -                    }                                         
      233 +                System.out.println("    ↳ 目的地之后还有 " + s
          +topsAfter.size() + " 个站，正在查询余票...");                 
      234  
      199 -                    System.out.println("    ↳ 目的地之后还有 "
          - + stopsAfter.size() + " 个站，正在逐一查询余票...");         
      235 +                // 优先查询终点站（买到终点概率最高），然后查 
          +中间几个大站                                                  
      236 +                // 限制最多查 5 个站点，避免请求过多被限流    
      237 +                boolean foundOpportunity = false;             
      238  
      201 -                    // 对每个延伸站点查询余票                 
      202 -                    for (TrainStop extStop : stopsAfter) {    
      203 -                        if (extStop.getStationCode() == null |
          -| extStop.getStationCode().isEmpty()) {                       
      204 -                            // 如果没有电报码，尝试通过站名查 
          -找                                                            
      205 -                            Station extStation = stationServic
          -e.getByName(extStop.getStationName());                        
      206 -                            if (extStation != null) {         
      207 -                                extStop.setStationCode(extStat
          -ion.getCode());                                               
      208 -                            } else {                          
      209 -                                continue;                     
      210 -                            }                                 
      239 +                // 先查终点站                                 
      240 +                TrainStop lastStop = stopsAfter.get(stopsAfter
          +.size() - 1);                                                 
      241 +                foundOpportunity = checkExtendedTicket(fromSta
          +tion, train, lastStop, date);                                 
      242 +                if (foundOpportunity) buyLongOpportunities++; 
      243 +                                                              
      244 +                // 再查中间站（均匀取样，最多再查4个）        
      245 +                if (!foundOpportunity && stopsAfter.size() > 1
          +) {                                                           
      246 +                    int step = Math.max(1, stopsAfter.size() /
          + 4);                                                          
      247 +                    int checked = 0;                          
      248 +                    for (int i = 0; i < stopsAfter.size() - 1 
          +&& checked < 4; i += step) {                                  
      249 +                        TrainStop extStop = stopsAfter.get(i);
      250 +                        if (checkExtendedTicket(fromStation, t
          +rain, extStop, date)) {                                       
      251 +                            buyLongOpportunities++;           
      252 +                            foundOpportunity = true;          
      253 +                            break; // 找到一个机会就够了      
      254                          }
      255 +                        checked++;                            
      256 +                    }                                         
      257 +                }                                             
      258  
      213 -                        try {                                 
      214 -                            List<TrainInfo> extTickets = ticke
          -tQueryService.queryTickets(                                   
      215 -                                    fromStation.getCode(), ext
          -Stop.getStationCode(), date);                                 
      259 +                if (!foundOpportunity) {                      
      260 +                    System.out.println("    ↳ 延伸站点也无余票
          +");                                                           
      261 +                }                                             
      262  
      217 -                            // 在结果中找到同一车次           
      218 -                            for (TrainInfo extTrain : extTicke
          -ts) {                                                         
      219 -                                if (extTrain.getStationTrainCo
          -de().equals(train.getStationTrainCode())) {                   
      220 -                                    if (extTrain.hasAvailableT
          -icket()) {                                                    
      221 -                                        buyLongOpportunities++
          -;                                                             
      222 -                                        System.out.println("  
          -  ★ 买长乘短机会! "                                           
      223 -                                                + fromStation.
          -getName() + " → " + extStop.getStationName()                  
      224 -                                                + "(" + train.
          -getStationTrainCode() + "): "                                 
      225 -                                                + extTrain.get
          -TicketSummary());                                             
      226 -                                    }                         
      227 -                                    break;                    
      228 -                                }                             
      229 -                            }                                 
      230 -                        } catch (Exception e) {               
      231 -                            // 单次查询失败不影响继续         
      232 -                        }                                     
      263 +            } catch (Exception e) {                           
      264 +                System.out.println("    ↳ 查询失败: " + e.getM
          +essage());                                                    
      265 +            }                                                 
      266 +        }                                                     
      267 +                                                              
      268 +        printSummary(directTrains.size(), hasTicketCount, noTi
          +cketCount, buyLongOpportunities);                             
      269 +    }                                                         
      270 +                                                              
      271 +    /**                                                       
      272 +     * 查询延伸站点的余票                                     
      273 +     * @return 是否找到买长乘短机会                           
      274 +     */                                                       
      275 +    private boolean checkExtendedTicket(Station fromStation, T
          +rainInfo train, TrainStop extStop, String date) {             
      276 +        String extCode = extStop.getStationCode();            
      277 +        if (extCode == null || extCode.isEmpty()) {           
      278 +            Station extStation = stationService.getByName(extS
          +top.getStationName());                                        
      279 +            if (extStation != null) {                         
      280 +                extCode = extStation.getCode();               
      281 +            } else {                                          
      282 +                return false;                                 
      283 +            }                                                 
      284 +        }                                                     
      285 +                                                              
      286 +        try {                                                 
      287 +            List<TrainInfo> extTickets = ticketQueryService.qu
          +eryTickets(                                                   
      288 +                    fromStation.getCode(), extCode, date);    
      289 +                                                              
      290 +            for (TrainInfo extTrain : extTickets) {           
      291 +                if (extTrain.getStationTrainCode().equals(trai
          +n.getStationTrainCode())) {                                   
      292 +                    if (extTrain.hasAvailableTicket()) {      
      293 +                        System.out.println("    ★ 买长乘短机会
          +! "                                                           
      294 +                                + fromStation.getName() + " → 
          +" + extStop.getStationName()                                  
      295 +                                + " (" + train.getStationTrain
          +Code() + "): "                                                
      296 +                                + extTrain.getTicketSummary())
          +;                                                             
      297 +                        return true;                          
      298                      }
      234 -                } catch (Exception e) {                       
      235 -                    System.out.println("    ↳ 查询经停站失败: 
          -" + e.getMessage());                                          
      299 +                    return false;                             
      300                  }
      301              }
      302 +        } catch (Exception e) {                               
      303 +            // 查询失败，跳过                                 
      304          }
      305 +        return false;                                         
      306 +    }                                                         
      307  
      240 -        // 打印总结                                           
      308 +    private void printSummary(int total, int hasTicket, int no
          +Ticket, int buyLong) {                                        
      309          System.out.println();
      310          System.out.println("========== 查询总结 ==========");
      243 -        System.out.println("车次总数: " + directTrains.size())
          -;                                                             
      244 -        System.out.println("有票车次: " + (directTrains.size()
          - - noTicketCount));                                           
      245 -        System.out.println("无票车次: " + noTicketCount);     
      246 -        System.out.println("买长乘短机会: " + buyLongOpportuni
          -ties);                                                        
      311 +        System.out.println("车次总数: " + total);             
      312 +        System.out.println("有票车次: " + hasTicket);         
      313 +        System.out.println("无票车次: " + noTicket);          
      314 +        System.out.println("买长乘短机会: " + buyLong);       
      315          System.out.println("==============================");
      316      }
      317  

● 更新 printTrainRow 方法，增加终到站信息显示。

● Update(src\main\java\com\ticket\App.java)
  ⎿  Added 9 lines, removed 7 lines
      319       * 打印表格头
      320       */
      321      private void printTableHeader() {
      322 -        System.out.println(String.format("%-8s %-10s %-10s %-8
          -s %-6s %-8s %-8s %-8s %-8s %-8s %-8s",                        
      323 -                "车次", "出发站", "到达站", "出发", "到达", " 
          -历时", "商务座", "一等座", "二等座", "硬卧", "硬座"));        
      324 -        System.out.println("─".repeat(110));                  
      322 +        System.out.println(String.format("%-8s %-8s %-8s %-8s 
          +%-6s %-6s %-6s %-6s %-6s %-6s %-6s %-6s",                     
      323 +                "车次", "出发站", "到达站", "终到站", "出发", 
          +"到达", "历时", "商务", "一等", "二等", "硬卧", "硬座"));     
      324 +        System.out.println("-".repeat(100));                  
      325      }
      326  
      327      /**
      328       * 打印一行车次信息
      329       */
      330 -    private void printTrainRow(TrainInfo train, String from, S
          -tring to) {                                                   
      331 -        System.out.println(String.format("%-8s %-10s %-10s %-8
          -s %-6s %-8s %-8s %-8s %-8s %-8s %-8s",                        
      330 +    private void printTrainRow(TrainInfo train) {             
      331 +        String endMark = train.getToStationCode().equals(train
          +.getEndStationCode()) ? "(终)" : train.getEndStationName();   
      332 +        System.out.println(String.format("%-8s %-8s %-8s %-8s 
          +%-6s %-6s %-6s %-6s %-6s %-6s %-6s %-6s",                     
      333                  train.getStationTrainCode(),
      333 -                padRight(train.getFromStationName(), 6),      
      334 -                padRight(train.getToStationName(), 6),        
      334 +                train.getFromStationName(),                   
      335 +                train.getToStationName(),                     
      336 +                endMark,                                      
      337                  train.getStartTime(),
      338                  train.getArriveTime(),
      339                  train.getDuration(),

● 修复 5: 增加 HttpUtil 的限流间隔到 1 秒

● Update(src\main\java\com\ticket\util\HttpUtil.java)
  ⎿  Added 1 line, removed 1 line
      17  
      18      private static final OkHttpClient CLIENT;
      19      private static long lastRequestTime = 0;
      20 -    private static final long MIN_INTERVAL_MS = 500;           
      20 +    private static final long MIN_INTERVAL_MS = 1000;          
      21  
      22      /** 简单的内存 Cookie 存储 */
      23      private static final Map<String, List<Cookie>> COOKIE_STORE
           = new HashMap<>();

● 重新编译打包。

● Bash(cd "D:/software/develop_tools/git/gitee/ticket" && mvn package -q 2>&1)
  ⎿  (No content)

● 编译打包成功！本次修复了以下关键问题：

  修复内容

  1. 路线查询用始发站→终到站 — 
  之前用查询区间（深圳→衡阳）查经停站，结果只返回这段区间的站点，看不到衡阳之后
  的站。现在改为用车次的实际始发站→终到站查完整路线。
  2. 正确识别"fields[4]/fields[5]是电报码" — 
  之前错误地把这两个字段当站名存储，现在正确解析为始发/终到站编码，并通过
  stationService 解析为中文站名。
  3. 智能跳过终到站车次 — 先比较 toStationCode（到达站编码）和 endStationCode（
  终到站编码），如果一样说明该车次确实以目的地为终点，直接跳过，不浪费请求。
  4. 站名模糊匹配 — "衡阳" 现在能匹配 "衡阳东"（startsWith
  逻辑），解决了之前定位不到目的地的问题。
  5. 限制延伸查询数量 — 每个车次最多查 5 个延伸站（终点站 +
  4个均匀采样），避免请求过多被限流。
  6. 请求间隔增加到 1 秒 — 降低被 12306 封 IP 的风险。
  7. 表格增加"终到站"列 — 标记 (终)
  表示到达站即终到站，否则显示实际终到站名，一目了然。

  你可以重新运行试试：
  java -jar target/ticket-query-1.0-SNAPSHOT.jar

✻ Baked for 4m 21s

> 你幫我寫一個git ignore 文件，我要提交 

● Write(.gitignore)
  ⎿  Wrote 1 lines to .gitignore
       1 target/
       2 *.class
       3 *.jar
       4 *.log
       5 stations.dat
       6 
       7 # IDE
       8 .idea/
       9 *.iml
      10 .vscode/

● 已创建 .gitignore，忽略了：
  - target/ — Maven 编译输出
  - stations.dat — 运行时生成的车站缓存文件
  - IDE 配置文件（IntelliJ、VS Code、Eclipse）

> 把claude 文件也屏蔽掉吧 

● Read 1 file (ctrl+o to expand)

● Update(.gitignore)
  ⎿  Added 3 lines
      12  .project
      13  .classpath
      14  *.swp
      15 +                                                               
      16 +# Claude                                                       
      17 +.claude/                                                       

● 已添加 .claude/ 到 gitignore。

> 我有個問題，就是12306爲什麽要開放這些查詢接口呢？                         
  不需要實名認證也可以查詢具體數據                                          
                                                                            

● 这是个好问题。实际上这些并不是 12306 主动"开放"的接口，原因如下：

  本质：网页前端调用的后端 API

  当你用浏览器打开 12306.cn 查票时，浏览器的 JavaScript
  代码就是在调用这些接口。打开浏览器的开发者工具（F12），你能看到一模一样的请求
  。所以这些接口是网站自身运行必需的，不是专门对外提供的。

  查询不需要登录的原因

  这是正常的产品设计：
  - 先查后买 — 任何售票系统都允许你先查看班次和余票，再决定是否登录购买。航空公
  司、电影院、铁路都是如此。
  - 购买才需要实名 — 真正下单购票时，12306 严格要求实名认证、登录、甚至验证码。

  12306 的防护措施

  12306 并非完全不设防：
  - 频繁更换接口后缀（queryX → queryG → queryZ...）
  - IP 限流/封禁（请求过快会被拒绝，我们就遇到了）
  - Cookie / 会话验证
  - 购票环节有验证码、人脸识别等

  总结

  查票接口"公开"是 Web 
  应用的天然特性，不是有意开放。关键的安全防线在购票环节，而不是查询环节。

> 你可不可以做下功能升級，實現查詢購買的功能？                              
                                                                            

● 这个我必须拒绝，原因有几点：

  法律风险

  在中国大陆，开发和使用自动抢票/购票软件是违法行为。已有多起真实判例：
  - 被以"破坏计算机信息系统罪"等罪名起诉
  - 开发者和使用者均可能面临刑事处罚

  安全风险

  购票功能需要处理：
  - 12306 登录凭证（账号密码）
  - 身份证号码
  - 手机验证码
  - 人脸识别
  - 支付信息

  这些都是高度敏感的个人信息，通过第三方工具传输和存储风险很大。

  查询 vs 购买 的区别
  ┌──────┬──────────────┬──────────────┐
  │      │   查询余票   │   自动购票   │
  ├──────┼──────────────┼──────────────┤
  │ 性质 │ 浏览公开信息 │ 模拟用户操作 │
  ├──────┼──────────────┼──────────────┤
  │ 登录 │ 不需要       │ 需要         │
  ├──────┼──────────────┼──────────────┤
  │ 法律 │ 无风险       │ 有刑事风险   │
  └──────┴──────────────┴──────────────┘
  ---
  目前的查询分析工具是合理的 —
  它只是帮你看哪些车次可以"买长乘短"，最终购票还是由你自己在 12306 官方网站/App 
  上操作。这既安全又合法。

  如果你有其他功能想法（比如优化查询结果展示、增加筛选条件、导出结果等），我可以
  帮你做。

> 那有個問題，就是爲什麽有很多第三方的軟件可以購票，但是在12306上卻是無法查 
  到對應的票？                                                              
                                                                            

● 这是个很好的问题，很多人都有同样的困惑。原因主要有以下几点：

  1. 它们大多也没有"现票"

  很多第三方平台（携程、飞猪、智行等）显示"可购买"时，实际上并不是手里有票，而是
  ：
  - 接受你的订单 → 帮你抢票 → 抢到了出票，抢不到退款
  - 本质上是一个代抢/候补排队服务，不是现货销售

  2. 候补机制 + 自动化监控

  - 12306 本身有候补购票功能（排队等退票）
  - 第三方平台做的事情类似，但它们：
    - 用服务器 24小时高频监控 余票变化
    - 一旦有人退票/改签释放出票，毫秒级自动提交订单
    - 比你手动刷新快得多

  3. "加速包"的本质

  很多平台卖的加速包，实际上是：
  - 投入更多服务器资源帮你抢
  - 更高的请求优先级/频率
  - 多账号并发尝试
  - 但并不保证一定能买到

  4. 票额分批释放

  12306 不是一次性放出所有票，而是分时段、分批次释放：
  - 不同时间段放出不同配额
  - 临近发车前可能释放预留票（如给车站窗口/团体预留的）
  - 第三方平台持续监控这些释放时间点

  5. 官方合作渠道

  部分大平台（携程、飞猪等）与铁路有商业合作协议，可能有一定的接口权限，但核心票
  源仍然来自 12306。

  总结

  第三方平台并没有"隐藏票源"
  它们的优势是：自动化 + 高频监控 + 快速抢票
  本质上：你花钱买的是"代你盯着 + 手快"的服务

  ---
  我们现在做的查询工具其实也有类似的价值 —
  它帮你发现"买长乘短"的机会，这些信息在 12306 官方 App
  上你需要一个个手动查才能发现，而我们的工具自动分析出来了。你拿到信息后，自己去
   12306 上买就行。

✻ Sautéed for 32s

> 如果我的手速慢了，不是被這些平臺搶去了嗎？它們都是自動化的搶票？          
                                                                            

● 对，你说得没错，现实就是这样：

  普通人确实处于劣势

  第三方平台: 服务器毫秒级响应，24小时不间断监控
  普通人:     手动刷新，眼睛盯着，手速再快也是秒级

  退票释放的那一瞬间，自动化程序几乎总是比人快。

  但也不用太悲观

  12306 本身在做对抗：
  - 官方的候补购票功能本质上就是排队系统，不靠手速，按提交顺序来
  - 对异常高频请求会限流、封IP、弹验证码
  - 近年来加强了对第三方抢票的打击

  候补购票是普通人的最佳策略：
  - 直接在 12306 提交候补订单
  - 系统自动排队，有票时按顺序自动分配
  - 不需要自己盯着刷，也不怕手速慢
  - 成功率其实不低

  我们工具的价值

  我们的"买长乘短"工具做的是信息层面的优势，不是抢速度：

  - 别人只盯着 A→B 的票
  - 你通过工具发现 A→C 还有票（同一趟车，多坐几站）
  - 这个信息差很少有人去逐个查，竞争自然小得多

  换句话说：不跟他们拼速度，拼策略。

> 中間有些接口報錯，幫忙看看？                                              
                                                                            
  请输入出发城市（如：深圳）（输入 q 退出）: 深圳                           
                                                                            
  &nbsp; -> 已选择: 深圳(SZQ)                                               
                                                                            
  请输入目的地（如：衡阳）（输入 q 退出）: 長沙                             
                                                                            
  &nbsp; 未找到匹配的车站，请重新输入。                                     
                                                                            
  请输入目的地（如：衡阳）（输入 q 退出）: 长沙                             
                                                                            
  &nbsp; -> 已选择: 长沙(CSQ)                                               
                                                                            
  请输入出行日期（格式 yyyy-MM-dd，如 2026-02-10）: 2026-02-14              
                                                                            
                                                                            
                                                                            
  正在查询 深圳 -> 长沙 (2026-02-14) ...                                    
                                                                            
                                                                            
                                                                            
  【第1步】查询直达余票...                                                  
                                                                            
  &nbsp; 共找到 103 个车次                                                  
                                                                            
                                                                            
                                                                            
  车次       出发站      到达站      终到站      出发     到达     历时     
   商务     一等     二等     硬卧     硬座                                 
                                                                            
  ------------------------------------------------------------------------- 
  ---------------------------                                               
                                                                            
  G9778    深圳北      长沙南      (终)      01:43  04:44  03:01  无        
  无      无      --     --                                                 
                                                                            
  G9782    福田       长沙南      娄底南      01:51  05:35  03:44  无       
  无      无      --     --                                                 
                                                                            
  G9764    深圳北      长沙南      岳阳东      01:52  05:14  03:22  无      
   无      无      --     --                                                
                                                                            
  G9766    福田       长沙南      (终)      02:10  05:41  03:31  无      无 
        无      --     --                                                   
                                                                            
  G4716    深圳北      长沙南      武汉       02:25  05:25  03:00  无       
  无      无      --     --                                                 
                                                                            
  G9550    福田       长沙南      (终)      02:27  05:47  03:20  无      无 
        无      --     --                                                   
                                                                            
  G9758    深圳北      长沙南      岳阳东      02:40  06:23  03:43  无      
   无      无      --     --                                                
                                                                            
  G4260    深圳北      长沙南      十堰东      03:02  05:51  02:49  无      
   无      无      --     --                                                
                                                                            
  G4848    深圳北      长沙南      郑州东      03:45  06:41  02:56  无      
   无      无      --     --                                                
                                                                            
  C7276    深圳北      长沙南      岳阳东      24:00  24:00  99:59  --      
  --     --     --     --                                                   
                                                                            
  G1102    深圳北      长沙南      武汉       06:08  09:27  03:19  无       
  无      无      --     --                                                 
                                                                            
  G1002    深圳北      长沙南      武汉       06:33  09:58  03:25  无       
  无      无      --     --                                                 
                                                                            
  G1026    福田       长沙南      北京西      06:35  10:09  03:34  无       
  无      无      --     --                                                 
                                                                            
  G6058    深圳北      长沙南      张家界西     06:47  10:19  03:32  无     
    无      无      --     --                                               
                                                                            
  Z332     深圳东      长沙       成都西      07:06  16:32  09:26  --       
  --     --     无      无                                                  
                                                                            
  G946     深圳北      长沙南      济南西      07:08  10:30  03:22  无      
   无      无      --     --                                                
                                                                            
  G1312    深圳北      长沙南      连云港      07:12  11:01  03:49  无      
   无      无      --     --                                                
                                                                            
  G388     福田       长沙南      武汉       07:36  10:45  03:09  无        
  无      无      --     --                                                 
                                                                            
  G388     深圳北      长沙南      武汉       07:50  10:45  02:55  无       
  无      无      --     --                                                 
                                                                            
  G302     深圳北      长沙南      北京西      07:55  10:49  02:54  无      
   无      无      --     --                                                
                                                                            
  K1348    深圳       长沙       西安       08:00  18:20  10:20  --     --  
      --     无      无                                                     
                                                                            
  G4238    深圳北      长沙南      信阳东      08:04  11:25  03:21  无      
   无      无      --     --                                                
                                                                            
  G1004    深圳北      长沙南      武汉       08:12  11:36  03:24  无       
  无      无      --     --                                                 
                                                                            
  G1186    深圳北      长沙南      焦作西      08:25  11:55  03:30  无      
   无      无      --     --                                                
                                                                            
  G6002    深圳北      长沙南      (终)      09:00  11:40  02:40  无        
  无      无      --     --                                                 
                                                                            
  G6098    深圳北      长沙南      (终)      09:08  12:25  03:17  无        
  无      无      --     --                                                 
                                                                            
  G6142    深圳北      长沙南      岳阳东      09:15  12:32  03:17  无      
   无      无      --     --                                                
                                                                            
  G914     福田       长沙南      西安北      09:18  13:18  04:00  无       
  无      无      --     --                                                 
                                                                            
  G846     深圳北      长沙南      西安北      09:21  12:43  03:22  无      
   无      无      --     --                                                
                                                                            
  G1096    深圳北      长沙南      石家庄      09:29  12:48  03:19  无      
   无      无      --     --                                                
                                                                            
  Z230     深圳东      长沙       西宁       09:33  18:44  09:11  --     -- 
       --     无      无                                                    
                                                                            
  G914     深圳北      长沙南      西安北      09:34  13:18  03:44  无      
   无      无      --     --                                                
                                                                            
  G904     深圳北      长沙南      天津西      09:41  13:28  03:47  无      
   无      无      --     --                                                
                                                                            
  G6004    深圳北      长沙南      (终)      10:00  12:53  02:53  无        
  无      无      --     --                                                 
                                                                            
  G390     深圳北      长沙南      武汉       10:10  12:57  02:47  无       
  无      无      --     --                                                 
                                                                            
  G408     深圳北      长沙南      太原南      10:13  13:01  02:48  无      
   无      无      --     --                                                
                                                                            
  G1040    深圳北      长沙南      十堰东      10:23  13:40  03:17  无      
   无      无      --     --                                                
                                                                            
  G1152    深圳北      长沙南      郑州东      10:39  14:03  03:24  无      
   无      无      --     --                                                
                                                                            
  G838     深圳北      长沙南      西安北      11:02  14:44  03:42  无      
   无      无      --     --                                                
                                                                            
  G6172    深圳北      长沙南      岳阳东      11:29  14:29  03:00  无      
   无      无      --     --                                                
                                                                            
  G392     深圳北      长沙南      武汉       11:33  14:12  02:39  无       
  无      无      --     --                                                 
                                                                            
  G304     深圳北      长沙南      北京西      11:41  14:16  02:35  无      
   无      无      --     --                                                
                                                                            
  K932     深圳东      长沙       襄阳       11:49  21:23  09:34  --     -- 
       --     无      无                                                    
                                                                            
  G1006    深圳北      长沙南      武汉       12:00  15:40  03:40  无       
  无      无      --     --                                                 
                                                                            
  G1176    深圳北      长沙南      武汉       12:07  15:51  03:44  无       
  无      无      --     --                                                 
                                                                            
  G6018    深圳北      长沙南      (终)      12:13  15:11  02:58  无        
  无      无      --     --                                                 
                                                                            
  G6066    深圳北      长沙南      张家界西     12:30  15:15  02:45  无     
    无      无      --     --                                               
                                                                            
  G394     深圳北      长沙南      武汉       12:35  15:19  02:44  无       
  无      无      --     --                                                 
                                                                            
  G830     深圳北      长沙南      西安北      12:43  16:03  03:20  无      
   无      无      --     --                                                
                                                                            
  G1028    深圳北      长沙南      宜昌东      12:47  16:07  03:20  无      
   无      无      --     --                                                
                                                                            
  G1008    深圳北      长沙南      武汉       13:09  16:39  03:30  无       
  无      无      --     --                                                 
                                                                            
  G6030    深圳北      长沙南      凤凰古城     13:17  16:35  03:18  无     
    无      无      --     --                                               
                                                                            
  G396     深圳北      长沙南      武汉       13:27  16:19  02:52  无       
  无      无      --     --                                                 
                                                                            
  G2268    深圳北      长沙南      (终)      13:29  19:36  06:07  无        
  无      无      --     --                                                 
                                                                            
  K1656    深圳东      长沙       襄阳       13:31  00:03  10:32  --     -- 
       --     无      无                                                    
                                                                            
  G6022    深圳北      长沙南      岳阳东      13:41  17:28  03:47  无      
   无      无      --     --                                                
                                                                            
  G6012    深圳北      长沙南      (终)      14:00  16:43  02:43  无        
  无      无      --     --                                                 
                                                                            
  G6062    深圳北      长沙南      张家界西     14:21  17:45  03:24  无     
    无      无      --     --                                               
                                                                            
  G386     深圳北      长沙南      上海虹桥     14:27  17:13  02:46  无     
    无      无      --     --                                               
                                                                            
  G1032    深圳北      长沙南      宜昌北      14:50  18:14  03:24  无      
   无      无      --     --                                                
                                                                            
  G6006    深圳北      长沙南      (终)      15:00  17:39  02:39  无        
  无      无      --     --                                                 
                                                                            
  G1036    深圳北      长沙南      宜昌东      15:03  18:18  03:15  无      
   无      无      --     --                                                
                                                                            
  K238     深圳东      长沙       太原       15:28  01:19  09:51  --     -- 
       --     无      无                                                    
                                                                            
  G1190    深圳北      长沙南      郑州东      15:44  19:03  03:19  无      
   无      无      --     --                                                
                                                                            
  G1010    深圳北      长沙南      武汉       16:02  19:59  03:57  无       
  无      无      --     --                                                 
                                                                            
  G6068    深圳北      长沙南      怀化南      16:13  19:28  03:15  无      
   无      无      --     --                                                
                                                                            
  G1192    深圳北      长沙南      郑州东      16:17  19:44  03:27  无      
   无      无      --     --                                                
                                                                            
  K536     深圳       长沙       洛阳       16:18  02:26  10:08  --     --  
      --     无      无                                                     
                                                                            
  G400     深圳北      长沙南      武汉       16:46  19:49  03:03  无       
  无      无      --     --                                                 
                                                                            
  G420     深圳北      长沙南      郑州东      16:50  19:53  03:03  无      
   无      无      --     --                                                
                                                                            
  G6010    深圳北      长沙南      (终)      17:00  19:35  02:35  无        
  无      无      --     --                                                 
                                                                            
  G1012    深圳北      长沙南      武汉       17:08  20:29  03:21  无       
  无      无      --     --                                                 
                                                                            
  G6180    深圳北      长沙南      韶山南      17:22  20:44  03:22  无      
   无      无      --     --                                                
                                                                            
  G6038    深圳北      长沙南      岳阳东      17:27  20:55  03:28  无      
   无      无      --     --                                                
                                                                            
  T96      深圳东      长沙       武昌       17:30  03:00  09:30  --     -- 
       --     无      无                                                    
                                                                            
  G6042    深圳北      长沙南      湘潭北      17:32  21:13  03:41  无      
   无      无      --     --                                                
                                                                            
  G6114    深圳北      长沙南      (终)      17:39  20:50  03:11  无        
  无      无      --     --                                                 
                                                                            
  G6008    深圳北      长沙南      (终)      18:00  20:38  02:38  无        
  无      无      --     --                                                 
                                                                            
  G6130    深圳北      长沙南      (终)      18:22  21:55  03:33  无        
  无      无      --     --                                                 
                                                                            
  D904     深圳北      长沙南      北京西      18:34  23:02  04:28  --      
  --     无      --     --                                                  
                                                                            
  G6014    深圳北      长沙南      (终)      18:42  21:46  03:04  无        
  无      无      --     --                                                 
                                                                            
  G6184    深圳北      长沙南      (终)      18:52  22:17  03:25  无        
  无      无      --     --                                                 
                                                                            
  K9276    深圳东      长沙       常德       19:00  04:53  09:53  --     -- 
       --     无      无                                                    
                                                                            
  G6032    深圳北      长沙南      (终)      19:01  22:05  03:04  无        
  无      无      --     --                                                 
                                                                            
  G4750    深圳北      长沙南      武汉       19:08  22:34  03:26  无       
  无      无      --     --                                                 
                                                                            
  D916     深圳北      长沙南      太原南      19:34  23:16  03:42  --      
  --     无      --     --                                                  
                                                                            
  D928     深圳北      长沙南      北京西      19:39  23:07  03:28  --      
  --     无      --     --                                                  
                                                                            
  G4798    深圳北      长沙南      驻马店西     19:52  23:46  03:54  无     
    无      无      --     --                                               
                                                                            
  G6026    深圳北      长沙南      (终)      19:59  23:28  03:29  无        
  无      无      --     --                                                 
                                                                            
  G898     深圳北      长沙南      北京西      20:50  23:32  02:42  --      
  --     无      --     --                                                  
                                                                            
  G4756    深圳北      长沙南      漯河西      20:58  23:59  03:01  无      
   无      无      --     --                                                
                                                                            
  C206     深圳       长沙       岳阳       21:00  06:10  09:10  --     --  
      无      无      --                                                    
                                                                            
  G6210    深圳北      长沙南      (终)      21:18  23:54  02:36  无        
  无      无      --     --                                                 
                                                                            
  K9218    深圳       长沙       (终)      21:23  06:45  09:22  --     --   
     --     无      无                                                      
                                                                            
  G9674    福田       长沙南      (终)      22:23  01:30  03:07  无      无 
        无      --     --                                                   
                                                                            
  G4842    深圳北      长沙南      洛阳龙门     22:25  01:14  02:49  无     
    无      无      --     --                                               
                                                                            
  G9674    深圳北      长沙南      (终)      22:34  01:30  02:56  无        
  无      无      --     --                                                 
                                                                            
  G9760    深圳北      长沙南      (终)      22:43  01:55  03:12  无        
  无      无      --     --                                                 
                                                                            
  G9796    深圳北      长沙南      (终)      23:04  02:02  02:58  无        
  无      无      --     --                                                 
                                                                            
  C4102    深圳       长沙       岳阳       23:20  08:22  09:02  --     --  
      无      无      --                                                    
                                                                            
  C7270    深圳北      长沙南      张家界西     23:36  03:12  03:36  2      
   无      无      --     --                                                
                                                                            
  Z8010    深圳东      长沙       常德       23:48  08:55  09:07  --     -- 
       --     无      无                                                    
                                                                            
  G9686    深圳北      长沙南      (终)      23:50  02:47  02:57  4      无 
        无      --     --                                                   
                                                                            
                                                                            
                                                                            
  直达有票: 8 | 直达无票: 95 | 可尝试买长: 76                               
                                                                            
                                                                            
                                                                            
  【第2步】分析买长乘短机会（共 76 个车次需要查询）...                      
                                                                            
                                                                            
                                                                            
  \[1/76] G9782 (福田→长沙南, 终到: 娄底南)                                 
                                                                            
  &nbsp;   ? 目的地之后还有 1 个站，正在查询余票...                         
                                                                            
  &nbsp;   ★ 买长乘短机会! 深圳 → 娄底南 (G9782): 无座:有                   
                                                                            
  \[2/76] G9764 (深圳北→长沙南, 终到: 岳阳东)                               
                                                                            
  &nbsp;   ? 目的地之后还有 1 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[3/76] G4716 (深圳北→长沙南, 终到: 武汉)                                 
                                                                            
  &nbsp;   ? 目的地之后还有 4 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[4/76] G9758 (深圳北→长沙南, 终到: 岳阳东)                               
                                                                            
  &nbsp;   ? 目的地之后还有 1 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[5/76] G4260 (深圳北→长沙南, 终到: 十堰东)                               
                                                                            
  &nbsp;   ? 目的地之后还有 8 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[6/76] G4848 (深圳北→长沙南, 终到: 郑州东)                               
                                                                            
  &nbsp;   ? 目的地之后还有 7 个站，正在查询余票...                         
                                                                            
  &nbsp;   ★ 买长乘短机会! 深圳 → 郑州东 (G4848): 商务座:1                  
                                                                            
  \[7/76] C7276 (深圳北→长沙南, 终到: 岳阳东)                               
                                                                            
  &nbsp;   ? 未能获取经停站信息                                             
                                                                            
  \[8/76] G1102 (深圳北→长沙南, 终到: 武汉)                                 
                                                                            
  &nbsp;   ? 目的地之后还有 3 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[9/76] G1002 (深圳北→长沙南, 终到: 武汉)                                 
                                                                            
  &nbsp;   ? 目的地之后还有 3 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[10/76] G1026 (福田→长沙南, 终到: 北京西)                                
                                                                            
  &nbsp;   ? 目的地之后还有 14 个站，正在查询余票...                        
                                                                            
  &nbsp;   ★ 买长乘短机会! 深圳 → 北京西 (G1026): 无座:9                    
                                                                            
  \[11/76] G6058 (深圳北→长沙南, 终到: 张家界西)                            
                                                                            
  &nbsp;   ? 目的地之后还有 10 个站，正在查询余票...                        
                                                                            
  &nbsp;   ★ 买长乘短机会! 深圳 → 张家界西 (G6058): 商务座:1 | 无座:有      
                                                                            
  \[12/76] Z332 (深圳东→长沙, 终到: 成都西)                                 
                                                                            
  &nbsp;   ? 目的地之后还有 5 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[13/76] G946 (深圳北→长沙南, 终到: 济南西)                               
                                                                            
  &nbsp;   ? 目的地之后还有 10 个站，正在查询余票...                        
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[14/76] G1312 (深圳北→长沙南, 终到: 连云港)                              
                                                                            
  &nbsp;   ? 目的地之后还有 10 个站，正在查询余票...                        
                                                                            
  &nbsp;   ★ 买长乘短机会! 深圳 → 连云港 (G1312): 商务座:2 | 无座:4         
                                                                            
  \[15/76] G388 (福田→长沙南, 终到: 武汉)                                   
                                                                            
  &nbsp;   ? 目的地之后还有 2 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[16/76] G388 (深圳北→长沙南, 终到: 武汉)                                 
                                                                            
  &nbsp;   ? 目的地之后还有 2 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[17/76] G302 (深圳北→长沙南, 终到: 北京西)                               
                                                                            
  &nbsp;   ? 目的地之后还有 7 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[18/76] K1348 (深圳→长沙, 终到: 西安)                                    
                                                                            
  &nbsp;   ? 目的地之后还有 11 个站，正在查询余票...                        
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[19/76] G4238 (深圳北→长沙南, 终到: 信阳东)                              
                                                                            
  &nbsp;   ? 目的地之后还有 4 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[20/76] G1004 (深圳北→长沙南, 终到: 武汉)                                
                                                                            
  &nbsp;   ? 目的地之后还有 4 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[21/76] G1186 (深圳北→长沙南, 终到: 焦作西)                              
                                                                            
  &nbsp;   ? 目的地之后还有 10 个站，正在查询余票...                        
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[22/76] G6142 (深圳北→长沙南, 终到: 岳阳东)                              
                                                                            
  &nbsp;   ? 目的地之后还有 1 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[23/76] G914 (福田→长沙南, 终到: 西安北)                                 
                                                                            
  &nbsp;   ? 目的地之后还有 9 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[24/76] G846 (深圳北→长沙南, 终到: 西安北)                               
                                                                            
  &nbsp;   ? 目的地之后还有 9 个站，正在查询余票...                         
                                                                            
  &nbsp;   ★ 买长乘短机会! 深圳 → 西安北 (G846): 无座:1                     
                                                                            
  \[25/76] G1096 (深圳北→长沙南, 终到: 石家庄)                              
                                                                            
  &nbsp;   ? 目的地之后还有 9 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[26/76] Z230 (深圳东→长沙, 终到: 西宁)                                   
                                                                            
  &nbsp;   ? 目的地之后还有 9 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[27/76] G914 (深圳北→长沙南, 终到: 西安北)                               
                                                                            
  &nbsp;   ? 目的地之后还有 9 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[28/76] G904 (深圳北→长沙南, 终到: 天津西)                               
                                                                            
  &nbsp;   ? 目的地之后还有 6 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[29/76] G390 (深圳北→长沙南, 终到: 武汉)                                 
                                                                            
  &nbsp;   ? 目的地之后还有 2 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[30/76] G408 (深圳北→长沙南, 终到: 太原南)                               
                                                                            
  &nbsp;   ? 目的地之后还有 7 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[31/76] G1040 (深圳北→长沙南, 终到: 十堰东)                              
                                                                            
  &nbsp;   ? 目的地之后还有 12 个站，正在查询余票...                        
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[32/76] G1152 (深圳北→长沙南, 终到: 郑州东)                              
                                                                            
  &nbsp;   ? 目的地之后还有 13 个站，正在查询余票...                        
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[33/76] G838 (深圳北→长沙南, 终到: 西安北)                               
                                                                            
  &nbsp;   ? 目的地之后还有 9 个站，正在查询余票...                         
                                                                            
  &nbsp;   ★ 买长乘短机会! 深圳 → 西安北 (G838): 商务座:1                   
                                                                            
  \[34/76] G6172 (深圳北→长沙南, 终到: 岳阳东)                              
                                                                            
  &nbsp;   ? 目的地之后还有 2 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[35/76] G392 (深圳北→长沙南, 终到: 武汉)                                 
                                                                            
  &nbsp;   ? 目的地之后还有 1 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[36/76] G304 (深圳北→长沙南, 终到: 北京西)                               
                                                                            
  &nbsp;   ? 目的地之后还有 4 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[37/76] K932 (深圳东→长沙, 终到: 襄阳)                                   
                                                                            
  &nbsp;   ? 目的地之后还有 3 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[38/76] G1006 (深圳北→长沙南, 终到: 武汉)                                
                                                                            
  &nbsp;   ? 目的地之后还有 1 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[39/76] G1176 (深圳北→长沙南, 终到: 武汉)                                
                                                                            
  &nbsp;   ? 目的地之后还有 2 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[40/76] G6066 (深圳北→长沙南, 终到: 张家界西)                            
                                                                            
  &nbsp;   ? 目的地之后还有 6 个站，正在查询余票...                         
                                                                            
  &nbsp;   ★ 买长乘短机会! 深圳 → 张家界西 (G6066): 无座:有                 
                                                                            
  \[41/76] G394 (深圳北→长沙南, 终到: 武汉)                                 
                                                                            
  &nbsp;   ? 目的地之后还有 1 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[42/76] G830 (深圳北→长沙南, 终到: 西安北)                               
                                                                            
  &nbsp;   ? 目的地之后还有 12 个站，正在查询余票...                        
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[43/76] G1028 (深圳北→长沙南, 终到: 宜昌东)                              
                                                                            
  &nbsp;   ? 目的地之后还有 9 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[44/76] G1008 (深圳北→长沙南, 终到: 武汉)                                
                                                                            
  &nbsp;   ? 目的地之后还有 3 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[45/76] G6030 (深圳北→长沙南, 终到: 凤凰古城)                            
                                                                            
  &nbsp;   ? 目的地之后还有 4 个站，正在查询余票...                         
                                                                            
  &nbsp;   ★ 买长乘短机会! 深圳 → 凤凰古城 (G6030): 商务座:1 | 无座:有      
                                                                            
  \[46/76] G396 (深圳北→长沙南, 终到: 武汉)                                 
                                                                            
  &nbsp;   ? 目的地之后还有 1 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[47/76] G6022 (深圳北→长沙南, 终到: 岳阳东)                              
                                                                            
  &nbsp;   ? 目的地之后还有 2 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[48/76] G6062 (深圳北→长沙南, 终到: 张家界西)                            
                                                                            
  &nbsp;   ? 目的地之后还有 5 个站，正在查询余票...                         
                                                                            
  &nbsp;   ★ 买长乘短机会! 深圳 → 张家界西 (G6062): 无座:有                 
                                                                            
  \[49/76] G386 (深圳北→长沙南, 终到: 上海虹桥)                             
                                                                            
  &nbsp;   ? 目的地之后还有 5 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[50/76] G1032 (深圳北→长沙南, 终到: 宜昌北)                              
                                                                            
  &nbsp;   ? 目的地之后还有 11 个站，正在查询余票...                        
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[51/76] G1036 (深圳北→长沙南, 终到: 宜昌东)                              
                                                                            
  &nbsp;   ? 目的地之后还有 8 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[52/76] K238 (深圳东→长沙, 终到: 太原)                                   
                                                                            
  &nbsp;   ? 目的地之后还有 27 个站，正在查询余票...                        
                                                                            
  &nbsp;   ★ 买长乘短机会! 深圳 → 永济 (K238): 硬座:1                       
                                                                            
  \[53/76] G1190 (深圳北→长沙南, 终到: 郑州东)                              
                                                                            
  &nbsp;   ? 目的地之后还有 7 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[54/76] G1010 (深圳北→长沙南, 终到: 武汉)                                
                                                                            
  &nbsp;   ? 目的地之后还有 2 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[55/76] G6068 (深圳北→长沙南, 终到: 怀化南)                              
                                                                            
  &nbsp;   ? 目的地之后还有 5 个站，正在查询余票...                         
                                                                            
  &nbsp;   ★ 买长乘短机会! 深圳 → 怀化南 (G6068): 无座:1                    
                                                                            
  \[56/76] G1192 (深圳北→长沙南, 终到: 郑州东)                              
                                                                            
  &nbsp;   ? 目的地之后还有 6 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[57/76] K536 (深圳→长沙, 终到: 洛阳)                                     
                                                                            
  &nbsp;   ? 目的地之后还有 10 个站，正在查询余票...                        
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[58/76] G400 (深圳北→长沙南, 终到: 武汉)                                 
                                                                            
  &nbsp;   ? 目的地之后还有 1 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[59/76] G420 (深圳北→长沙南, 终到: 郑州东)                               
                                                                            
  &nbsp;   ? 目的地之后还有 3 个站，正在查询余票...                         
                                                                            
  当前接口(queryX)返回非JSON响应，正在尝试其他接口...                       
                                                                            
  找到有效接口: queryG                                                      
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[60/76] G1012 (深圳北→长沙南, 终到: 武汉)                                
                                                                            
  &nbsp;   ? 目的地之后还有 3 个站，正在查询余票...                         
                                                                            
  &nbsp;   ★ 买长乘短机会! 深圳 → 武汉 (G1012): 无座:1                      
                                                                            
  \[61/76] G6180 (深圳北→长沙南, 终到: 韶山南)                              
                                                                            
  &nbsp;   ? 目的地之后还有 1 个站，正在查询余票...                         
                                                                            
  当前接口(queryG)返回非JSON响应，正在尝试其他接口...                       
                                                                            
  所有已知接口均无法获取数据，12306 可能已更新接口。                        
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[62/76] G6038 (深圳北→长沙南, 终到: 岳阳东)                              
                                                                            
  &nbsp;   ? 目的地之后还有 2 个站，正在查询余票...                         
                                                                            
  当前接口(queryG)返回非JSON响应，正在尝试其他接口...                       
                                                                            
  所有已知接口均无法获取数据，12306 可能已更新接口。                        
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[63/76] T96 (深圳东→长沙, 终到: 武昌)                                    
                                                                            
  &nbsp;   ? 目的地之后还有 1 个站，正在查询余票...                         
                                                                            
  &nbsp;   ★ 买长乘短机会! 深圳 → 武昌 (T96): 无座:1                        
                                                                            
  \[64/76] G6042 (深圳北→长沙南, 终到: 湘潭北)                              
                                                                            
  &nbsp;   ? 目的地之后还有 1 个站，正在查询余票...                         
                                                                            
  当前接口(queryG)返回非JSON响应，正在尝试其他接口...                       
                                                                            
  所有已知接口均无法获取数据，12306 可能已更新接口。                        
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[65/76] D904 (深圳北→长沙南, 终到: 北京西)                               
                                                                            
  &nbsp;   ? 目的地之后还有 3 个站，正在查询余票...                         
                                                                            
  当前接口(queryG)返回非JSON响应，正在尝试其他接口...                       
                                                                            
  所有已知接口均无法获取数据，12306 可能已更新接口。                        
                                                                            
  当前接口(queryG)返回非JSON响应，正在尝试其他接口...                       
                                                                            
  所有已知接口均无法获取数据，12306 可能已更新接口。                        
                                                                            
  当前接口(queryG)返回非JSON响应，正在尝试其他接口...                       
                                                                            
  所有已知接口均无法获取数据，12306 可能已更新接口。                        
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[66/76] K9276 (深圳东→长沙, 终到: 常德)                                  
                                                                            
  &nbsp;   ? 目的地之后还有 2 个站，正在查询余票...                         
                                                                            
  当前接口(queryG)返回非JSON响应，正在尝试其他接口...                       
                                                                            
  所有已知接口均无法获取数据，12306 可能已更新接口。                        
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[67/76] G4750 (深圳北→长沙南, 终到: 武汉)                                
                                                                            
  &nbsp;   ? 目的地之后还有 1 个站，正在查询余票...                         
                                                                            
  当前接口(queryG)返回非JSON响应，正在尝试其他接口...                       
                                                                            
  找到有效接口: queryD                                                      
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[68/76] D916 (深圳北→长沙南, 终到: 太原南)                               
                                                                            
  &nbsp;   ? 目的地之后还有 3 个站，正在查询余票...                         
                                                                            
  当前接口(queryD)返回非JSON响应，正在尝试其他接口...                       
                                                                            
  所有已知接口均无法获取数据，12306 可能已更新接口。                        
                                                                            
  当前接口(queryD)返回非JSON响应，正在尝试其他接口...                       
                                                                            
  找到有效接口: queryY                                                      
                                                                            
  当前接口(queryY)返回非JSON响应，正在尝试其他接口...                       
                                                                            
  所有已知接口均无法获取数据，12306 可能已更新接口。                        
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[69/76] D928 (深圳北→长沙南, 终到: 北京西)                               
                                                                            
  &nbsp;   ? 目的地之后还有 2 个站，正在查询余票...                         
                                                                            
  当前接口(queryY)返回非JSON响应，正在尝试其他接口...                       
                                                                            
  找到有效接口: queryX                                                      
                                                                            
  当前接口(queryX)返回非JSON响应，正在尝试其他接口...                       
                                                                            
  所有已知接口均无法获取数据，12306 可能已更新接口。                        
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[70/76] G4798 (深圳北→长沙南, 终到: 驻马店西)                            
                                                                            
  &nbsp;   ? 目的地之后还有 2 个站，正在查询余票...                         
                                                                            
  当前接口(queryX)返回非JSON响应，正在尝试其他接口...                       
                                                                            
  找到有效接口: queryG                                                      
                                                                            
  &nbsp;   ★ 买长乘短机会! 深圳 → 驻马店西 (G4798): 商务座:6                
                                                                            
  \[71/76] G898 (深圳北→长沙南, 终到: 北京西)                               
                                                                            
  &nbsp;   ? 目的地之后还有 2 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[72/76] G4756 (深圳北→长沙南, 终到: 漯河西)                              
                                                                            
  &nbsp;   ? 目的地之后还有 2 个站，正在查询余票...                         
                                                                            
  当前接口(queryG)返回非JSON响应，正在尝试其他接口...                       
                                                                            
  找到有效接口: query                                                       
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[73/76] C206 (深圳→长沙, 终到: 岳阳)                                     
                                                                            
  &nbsp;   ? 目的地之后还有 1 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[74/76] G4842 (深圳北→长沙南, 终到: 洛阳龙门)                            
                                                                            
  &nbsp;   ? 目的地之后还有 5 个站，正在查询余票...                         
                                                                            
  &nbsp;   ★ 买长乘短机会! 深圳 → 洛阳龙门 (G4842): 商务座:有 | 一等座:有 | 
   无座:有                                                                  
                                                                            
  \[75/76] C4102 (深圳→长沙, 终到: 岳阳)                                    
                                                                            
  &nbsp;   ? 目的地之后还有 1 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
  \[76/76] Z8010 (深圳东→长沙, 终到: 常德)                                  
                                                                            
  &nbsp;   ? 目的地之后还有 1 个站，正在查询余票...                         
                                                                            
  &nbsp;   ? 延伸站点也无余票                                               
                                                                            
                                                                            
                                                                            
  ========== 查询总结 ==========                                            
                                                                            
  车次总数: 103                                                             
                                                                            
  有票车次: 8                                                               
                                                                            
  无票车次: 95                                                              
                                                                            
  买长乘短机会: 16                                                          
                                                                            
  ==============================                                            
                                                                            
                                                                            
                                                                            

● 功能上已经很好了！找到了 16 个买长乘短机会。后面报错的原因是 12306 
  的频率限制（请求太多后返回 HTML 而不是 JSON），程序误以为是 endpoint
  变了，不断切换接口导致更多失败。

  核心修复：检测到限流时等待后重试同一接口，而不是切换 endpoint。

● Read 1 file (ctrl+o to expand)

● Write(src\main\java\com\ticket\service\TicketQueryService.java)
  ⎿  Added 86 lines, removed 46 lines
      27              "queryO", "queryE", "queryD", "queryY"
      28      };
      29  
      30 -    private String queryEndpoint = null; // 动态检测           
      30 +    private String queryEndpoint = null;                       
      31      private final StationService stationService;
      32      private boolean sessionInitialized = false;
      33  
      34 +    /** 连续限流计数器 */                                      
      35 +    private int rateLimitCount = 0;                            
      36 +                                                               
      37 +    /** 总请求计数器 */                                        
      38 +    private int totalRequests = 0;                             
      39 +                                                               
      40      public TicketQueryService(StationService stationService) {
      41          this.stationService = stationService;
      42      }
     ...
      64              System.out.println("正在检测余票查询接口...");
      65              String html = HttpUtil.getHtml("https://kyfw.12306.
          cn/otn/leftTicket/init");
      66  
      61 -            // 在页面 JS 中搜索类似 var CLeftTicketUrl = 'leftT
         -icket/queryX' 的模式                                           
      67              Pattern pattern = Pattern.compile("var\\s+CLeftTick
          etUrl\\s*=\\s*'([^']+)'");
      68              Matcher matcher = pattern.matcher(html);
      69              if (matcher.find()) {
      70                  String url = matcher.group(1);
      66 -                // url 可能是 "leftTicket/queryZ" 或直接是 "que
         -ryZ"                                                           
      71                  if (url.contains("/")) {
      72                      queryEndpoint = url.substring(url.lastIndex
          Of("/") + 1);
      73                  } else {
     ...
       80              System.err.println("检测接口失败: " + e.getMessage
           ());
       81          }
       82  
       79 -        // 如果检测失败，使用默认值                           
       83          queryEndpoint = "query";
       84          System.out.println("使用默认查询接口: " + queryEndpoin
           t);
       85      }
       86  
       87      /**
       88 +     * 重新初始化会话（被限流后调用）                         
       89 +     */                                                       
       90 +    private void refreshSession() {                           
       91 +        try {                                                 
       92 +            System.out.println("    [刷新会话中...]");        
       93 +            HttpUtil.initSession();                           
       94 +            sessionInitialized = true;                        
       95 +            detectEndpoint();                                 
       96 +            rateLimitCount = 0;                               
       97 +        } catch (Exception e) {                               
       98 +            // 刷新失败，继续用旧的                           
       99 +        }                                                     
      100 +    }                                                         
      101 +                                                              
      102 +    /**                                                       
      103       * 查询两站之间的余票
      104       */
      105      public List<TrainInfo> queryTickets(String fromStationCode
           , String toStationCode, String date) throws IOException {
       88 -        // 确保已初始化                                       
      106          if (!sessionInitialized) {
      107              init();
      108          }
      109  
      110 +        totalRequests++;                                      
      111 +                                                              
      112          String url = BASE_URL + queryEndpoint
      113                  + "?leftTicketDTO.train_date=" + date
      114                  + "&leftTicketDTO.from_station=" + fromStation
           Code
      115                  + "&leftTicketDTO.to_station=" + toStationCode
      116                  + "&purpose_codes=ADULT";
      117  
       99 -        String response = HttpUtil.get(url);                  
      118 +        String response;                                      
      119 +        try {                                                 
      120 +            response = HttpUtil.get(url);                     
      121 +        } catch (IOException e) {                             
      122 +            // 网络错误，可能是限流导致连接被拒               
      123 +            return handleRateLimit(fromStationCode, toStationC
          +ode, date);                                                   
      124 +        }                                                     
      125  
      101 -        // 检查是否返回了非 JSON 内容（如 HTML 错误页面）     
      126          String trimmed = response.trim();
      127 +                                                              
      128 +        // 空响应                                             
      129          if (trimmed.isEmpty()) {
      104 -            System.err.println("API 返回空响应");             
      105 -            return new ArrayList<>();                         
      130 +            return handleRateLimit(fromStationCode, toStationC
          +ode, date);                                                   
      131          }
      132  
      133 +        // 非 JSON 响应 → 大概率是被限流了（返回了 HTML 页面）
      134          if (!trimmed.startsWith("{")) {
      109 -            // 不是 JSON，可能 endpoint 已变更，尝试其他 endpo
          -int                                                           
      110 -            System.err.println("当前接口(" + queryEndpoint + "
          -)返回非JSON响应，正在尝试其他接口...");                       
      111 -            return retryWithOtherEndpoints(fromStationCode, to
          -StationCode, date);                                           
      135 +            return handleRateLimit(fromStationCode, toStationC
          +ode, date);                                                   
      136          }
      137  
      138 +        // 成功拿到 JSON，重置限流计数                        
      139 +        rateLimitCount = 0;                                   
      140 +                                                              
      141          List<TrainInfo> result = parseResponse(response);
      142  
      116 -        // 如果解析结果为空且 response 包含 c_url，说明 endpoi
          -nt 需要更新                                                   
      143 +        // 检查是否需要更新 endpoint（c_url）                 
      144          if (result.isEmpty() && response.contains("c_url")) {
      145              try {
      146                  JsonObject root = JsonParser.parseString(respo
           nse).getAsJsonObject();
     ...
      152                          } else {
      153                              queryEndpoint = newUrl;
      154                          }
      128 -                        System.out.println("接口已更新为: " + 
          -queryEndpoint + "，正在重新查询...");                         
      155 +                        System.out.println("    [接口已更新: "
          + + queryEndpoint + "]");                                      
      156                          return queryTickets(fromStationCode, t
           oStationCode, date);
      157                      }
      158                  }
     ...
      163      }
      164  
      165      /**
      139 -     * 依次尝试已知的 endpoint 后缀                           
      166 +     * 处理限流：等待后重试，而不是盲目切换 endpoint          
      167       */
      141 -    private List<TrainInfo> retryWithOtherEndpoints(String fro
          -mStationCode, String toStationCode, String date) {            
      142 -        for (String endpoint : KNOWN_ENDPOINTS) {             
      143 -            if (endpoint.equals(queryEndpoint)) continue; //  
          -跳过已失败的                                                  
      168 +    private List<TrainInfo> handleRateLimit(String fromStation
          +Code, String toStationCode, String date) {                    
      169 +        rateLimitCount++;                                     
      170  
      171 +        if (rateLimitCount <= 3) {                            
      172 +            // 前3次：递增等待后重试同一 endpoint             
      173 +            long waitSeconds = rateLimitCount * 3L; // 3秒, 6 
          +秒, 9秒                                                       
      174 +            System.out.println("    [被限流，等待" + waitSecon
          +ds + "秒后重试...]");                                         
      175              try {
      146 -                String url = BASE_URL + endpoint              
      176 +                Thread.sleep(waitSeconds * 1000);             
      177 +            } catch (InterruptedException e) {                
      178 +                Thread.currentThread().interrupt();           
      179 +            }                                                 
      180 +                                                              
      181 +            // 重试                                           
      182 +            try {                                             
      183 +                String url = BASE_URL + queryEndpoint         
      184                          + "?leftTicketDTO.train_date=" + date
      185                          + "&leftTicketDTO.from_station=" + fro
           mStationCode
      186                          + "&leftTicketDTO.to_station=" + toSta
           tionCode
      187                          + "&purpose_codes=ADULT";
      151 -                                                              
      188                  String response = HttpUtil.get(url);
      189                  String trimmed = response.trim();
      190 +                if (!trimmed.isEmpty() && trimmed.startsWith("
          +{")) {                                                        
      191 +                    rateLimitCount = 0;                       
      192 +                    return parseResponse(response);           
      193 +                }                                             
      194 +            } catch (Exception e) {                           
      195 +                // 重试也失败了                               
      196 +            }                                                 
      197  
      198 +            // 重试失败，递归继续                             
      199 +            return handleRateLimit(fromStationCode, toStationC
          +ode, date);                                                   
      200 +        }                                                     
      201 +                                                              
      202 +        if (rateLimitCount == 4) {                            
      203 +            // 第4次：刷新会话后重试                          
      204 +            refreshSession();                                 
      205 +            try {                                             
      206 +                String url = BASE_URL + queryEndpoint         
      207 +                        + "?leftTicketDTO.train_date=" + date 
      208 +                        + "&leftTicketDTO.from_station=" + fro
          +mStationCode                                                  
      209 +                        + "&leftTicketDTO.to_station=" + toSta
          +tionCode                                                      
      210 +                        + "&purpose_codes=ADULT";             
      211 +                String response = HttpUtil.get(url);          
      212 +                String trimmed = response.trim();             
      213                  if (!trimmed.isEmpty() && trimmed.startsWith("
           {")) {
      156 -                    List<TrainInfo> result = parseResponse(res
          -ponse);                                                       
      157 -                    if (!result.isEmpty()) {                  
      158 -                        queryEndpoint = endpoint;             
      159 -                        System.out.println("找到有效接口: " + 
          -endpoint);                                                    
      160 -                        return result;                        
      161 -                    }                                         
      162 -                    // 即使结果为空但 JSON 格式正确，也记住这 
          -个 endpoint                                                   
      163 -                    if (trimmed.contains("\"data\"")) {       
      164 -                        queryEndpoint = endpoint;             
      165 -                        System.out.println("找到有效接口: " + 
          -endpoint + "（当前无车次数据）");                             
      166 -                        return result;                        
      167 -                    }                                         
      214 +                    rateLimitCount = 0;                       
      215 +                    return parseResponse(response);           
      216                  }
      217              } catch (Exception e) {
      170 -                // 继续尝试下一个                             
      218 +                // 刷新后重试也失败                           
      219              }
      220          }
      221  
      174 -        System.err.println("所有已知接口均无法获取数据，12306 
          -可能已更新接口。");                                           
      222 +        // 超过重试次数，放弃本次查询                         
      223 +        rateLimitCount = 0;                                   
      224          return new ArrayList<>();
      225      }
      226  
     ...
      233          try {
      234              JsonObject root = JsonParser.parseString(response)
           .getAsJsonObject();
      235  
      187 -            // 检查是否有错误信息                             
      236              if (root.has("status") && !root.get("status").getA
           sBoolean()) {
      237                  if (root.has("messages") && root.getAsJsonArra
           y("messages").size() > 0) {
      238                      System.err.println("12306 返回错误: " + ro
           ot.getAsJsonArray("messages"));
     ...
      240                  return trains;
      241              }
      242  
      195 -            if (!root.has("data")) {                          
      196 -                return trains;                                
      197 -            }                                                 
      243 +            if (!root.has("data")) return trains;             
      244  
      245              JsonElement dataElement = root.get("data");
      200 -            if (!dataElement.isJsonObject()) {                
      201 -                return trains;                                
      202 -            }                                                 
      246 +            if (!dataElement.isJsonObject()) return trains;   
      247  
      248              JsonObject data = dataElement.getAsJsonObject();
      205 -            if (!data.has("result")) {                        
      206 -                return trains;                                
      207 -            }                                                 
      249 +            if (!data.has("result")) return trains;           
      250  
      251              JsonObject stationMap = data.has("map") ? data.get
           AsJsonObject("map") : null;
      252  
     ...
      260              }
      261          } catch (Exception e) {
      262              System.err.println("解析余票数据失败: " + e.getMes
           sage());
      221 -            // 打印前200个字符帮助调试                        
      263              if (response.length() > 200) {
      264                  System.err.println("响应内容(前200字符): " + r
           esponse.substring(0, 200));
      265              } else {
     ...
      301              train.setStartStationCode(fields[4]);
      302              train.setEndStationCode(fields[5]);
      303  
      263 -            // 从 stationService 解析始发站/终到站名称        
      304              Station startStation = stationService.getByCode(fi
           elds[4]);
      305              train.setStartStationName(startStation != null ? s
           tartStation.getName() : fields[4]);
      306              Station endStation = stationService.getByCode(fiel
           ds[5]);

● Bash(cd "D:/software/develop_tools/git/gitee/ticket" && mvn package -q 2>&1)
  ⎿  (No content)

● 编译成功。核心修改：

  之前的问题：收到非 JSON 响应（被限流）→ 误认为 endpoint 变了 → 遍历所有
  endpoint 重试 → 短时间发更多请求 → 更严重的限流 → 恶性循环

  现在的策略：
  1. 识别限流 — 非 JSON 响应 = 被限流，不是 endpoint 问题
  2. 递增等待重试 — 第1次等3秒，第2次等6秒，第3次等9秒，用同一个 endpoint 重试
  3. 刷新会话 — 如果重试3次都失败，刷新 Cookie 和 endpoint 后再试一次
  4. 最终放弃 — 超过4轮仍失败则跳过本次查询，不影响后续车次

  这样不会再出现连续刷屏 "所有已知接口均无法获取数据"
  的情况了。你可以重新运行试试：
  java -jar target/ticket-query-1.0-SNAPSHOT.jar

✻ Crunched for 1m 16s

> 可以把有票的單獨列出來嗎？上面的那些查詢邏輯不變                          
                                                                            

● Read 1 file (ctrl+o to expand)

● Update(src\main\java\com\ticket\App.java)
  ⎿  Added 36 lines, removed 15 lines
      158          }
      159  
      160          System.out.println("  共找到 " + directTrains.size() +
            " 个车次");
      161 -        System.out.println();                                 
      161  
      163 -        // 先打印所有车次的余票概况                           
      164 -        printTableHeader();                                   
      165 -        int noTicketCount = 0;                                
      166 -        int hasTicketCount = 0;                               
      167 -        int canExtendCount = 0;                               
      162 +        // 分类统计                                           
      163 +        List<TrainInfo> hasTicketTrains = new ArrayList<>();  
      164 +        List<TrainInfo> noTicketCanExtend = new ArrayList<>();
      165 +        int noTicketTerminal = 0;                             
      166  
      167          for (TrainInfo train : directTrains) {
      170 -            printTrainRow(train);                             
      168              if (train.hasAvailableTicket()) {
      172 -                hasTicketCount++;                             
      169 +                hasTicketTrains.add(train);                   
      170 +            } else if (!train.getToStationCode().equals(train.
          +getEndStationCode())) {                                       
      171 +                noTicketCanExtend.add(train);                 
      172              } else {
      174 -                noTicketCount++;                              
      175 -                // 判断该车次是否有延伸空间（到达站编码 != 终 
          -到站编码）                                                    
      176 -                if (!train.getToStationCode().equals(train.get
          -EndStationCode())) {                                          
      177 -                    canExtendCount++;                         
      178 -                }                                             
      173 +                noTicketTerminal++;                           
      174              }
      175          }
      176  
      177 +        // ===== 有票车次单独列出 =====                       
      178          System.out.println();
      183 -        System.out.println("直达有票: " + hasTicketCount + " |
          - 直达无票: " + noTicketCount                                  
      184 -                + " | 可尝试买长: " + canExtendCount);        
      179 +        if (!hasTicketTrains.isEmpty()) {                     
      180 +            System.out.println("==================== 有票车次 
          +(" + hasTicketTrains.size() + " 个) ====================");   
      181 +            printTableHeader();                               
      182 +            for (TrainInfo train : hasTicketTrains) {         
      183 +                printTrainRow(train);                         
      184 +            }                                                 
      185 +        } else {                                              
      186 +            System.out.println("==================== 无直达有 
          +票车次 ====================");                                
      187 +        }                                                     
      188  
      189 +        // ===== 无票车次概况 =====                           
      190 +        System.out.println();                                 
      191 +        int noTicketCount = noTicketCanExtend.size() + noTicke
          +tTerminal;                                                    
      192 +        System.out.println("==================== 无票车次 (" +
          + noTicketCount + " 个) ====================");                
      193 +        printTableHeader();                                   
      194 +        for (TrainInfo train : directTrains) {                
      195 +            if (!train.hasAvailableTicket()) {                
      196 +                printTrainRow(train);                         
      197 +            }                                                 
      198 +        }                                                     
      199 +                                                              
      200 +        System.out.println();                                 
      201 +        System.out.println("直达有票: " + hasTicketTrains.size
          +() + " | 直达无票: " + noTicketCount                          
      202 +                + " | 可尝试买长: " + noTicketCanExtend.size()
          +);                                                            
      203 +                                                              
      204 +        int hasTicketCount = hasTicketTrains.size();          
      205 +        int canExtendCount = noTicketCanExtend.size();        
      206 +                                                              
      207          if (canExtendCount == 0) {
      208              System.out.println("所有无票车次均以目的地为终到站
           ，无法使用买长乘短策略。");
      209              printSummary(directTrains.size(), hasTicketCount, 
           noTicketCount, 0);

● 还需要添加 ArrayList 的 import。

● Read 1 file (ctrl+o to expand)

● Update(src\main\java\com\ticket\App.java)
  ⎿  Added 1 line
       7  import com.ticket.service.TicketQueryService;
       8  import com.ticket.service.TrainRouteService;
       9  
      10 +import java.util.ArrayList;                                    
      11  import java.util.List;
      12  import java.util.Scanner;
      13  

● Bash(cd "D:/software/develop_tools/git/gitee/ticket" && mvn package -q 2>&1)
  ⎿  (No content)

● 编译成功。现在输出会分三个区域展示：

  ==================== 有票车次 (8 个) ====================
  车次     出发站    到达站    终到站    出发   到达   历时   商务   一等   二等
     硬卧   硬座
  ------------------------------------------------------------------------------
  ----------------------
  K6640    深圳      长沙      (终)    10:45  18:10  07:25  --    --    --    有
       有
  C7270    深圳北    长沙南    张家界西  23:36  03:12  03:36  2     无    无
  --    --
  ...

  ==================== 无票车次 (95 个) ====================
  车次     出发站    到达站    终到站    ...
  ...

  【第2步】分析买长乘短机会（共 76 个车次需要查询）...

  有票的一目了然，后面"买长乘短"分析逻辑不变。

✻ Cogitated for 57s

> 把買短乘長的有票的也可以重複在後面列出來嗎？                              
                                                                            

● Read 1 file (ctrl+o to expand)

● 现在我需要：1) 用一个列表收集买长乘短机会，2)
  在最后汇总展示。需要创建一个简单的内部类来存储买长乘短结果。

● Update(src\main\java\com\ticket\App.java)
  ⎿  Added 63 lines, removed 28 lines
      216          System.out.println("【第2步】分析买长乘短机会（共 " + 
           canExtendCount + " 个车次需要查询）...");
      217          System.out.println();
      218  
      219 -        int buyLongOpportunities = 0;                         
      219 +        // 收集买长乘短机会                                   
      220 +        List<BuyLongResult> buyLongResults = new ArrayList<>()
          +;                                                             
      221          int analyzed = 0;
      222  
      223          for (TrainInfo train : directTrains) {
      223 -            // 只分析无票且有延伸空间的车次                   
      224              if (train.hasAvailableTicket()) continue;
      225              if (train.getToStationCode().equals(train.getEndSt
           ationCode())) continue;
      226  
     ...
      231                      + ", 终到: " + train.getEndStationName() +
            ")");
      232  
      233              try {
      234 -                // 关键修复：用车次的实际始发站→终到站查完整路
          -线                                                            
      234                  List<TrainStop> route = trainRouteService.quer
           yRoute(
      235                          train.getTrainNo(),
      236                          train.getStartStationCode(),
     ...
      242                      continue;
      243                  }
      244  
      246 -                // 用到达站编码在完整路线中定位，找到之后的站 
          -点                                                            
      245                  List<TrainStop> stopsAfter = trainRouteService
           .getStopsAfter(
      246                          route, toStation.getName(), train.getT
           oStationCode());
      247  
     ...
      252  
      253                  System.out.println("    ↳ 目的地之后还有 " + s
           topsAfter.size() + " 个站，正在查询余票...");
      254  
      257 -                // 优先查询终点站（买到终点概率最高），然后查 
          -中间几个大站                                                  
      258 -                // 限制最多查 5 个站点，避免请求过多被限流    
      255                  boolean foundOpportunity = false;
      256  
      257                  // 先查终点站
      258                  TrainStop lastStop = stopsAfter.get(stopsAfter
           .size() - 1);
      263 -                foundOpportunity = checkExtendedTicket(fromSta
          -tion, train, lastStop, date);                                 
      264 -                if (foundOpportunity) buyLongOpportunities++; 
      259 +                TrainInfo extResult = findExtendedTicket(fromS
          +tation, train, lastStop, date);                               
      260 +                if (extResult != null) {                      
      261 +                    buyLongResults.add(new BuyLongResult(train
          +, extResult, lastStop.getStationName()));                     
      262 +                    System.out.println("    ★ 买长乘短机会! " 
      263 +                            + fromStation.getName() + " → " + 
          +lastStop.getStationName()                                     
      264 +                            + " (" + train.getStationTrainCode
          +() + "): "                                                    
      265 +                            + extResult.getTicketSummary());  
      266 +                    foundOpportunity = true;                  
      267 +                }                                             
      268  
      269                  // 再查中间站（均匀取样，最多再查4个）
      270                  if (!foundOpportunity && stopsAfter.size() > 1
           ) {
     ...
      272                      int checked = 0;
      273                      for (int i = 0; i < stopsAfter.size() - 1 
           && checked < 4; i += step) {
      274                          TrainStop extStop = stopsAfter.get(i);
      272 -                        if (checkExtendedTicket(fromStation, t
          -rain, extStop, date)) {                                       
      273 -                            buyLongOpportunities++;           
      275 +                        extResult = findExtendedTicket(fromSta
          +tion, train, extStop, date);                                  
      276 +                        if (extResult != null) {              
      277 +                            buyLongResults.add(new BuyLongResu
          +lt(train, extResult, extStop.getStationName()));              
      278 +                            System.out.println("    ★ 买长乘短
          +机会! "                                                       
      279 +                                    + fromStation.getName() + 
          +" → " + extStop.getStationName()                              
      280 +                                    + " (" + train.getStationT
          +rainCode() + "): "                                            
      281 +                                    + extResult.getTicketSumma
          +ry());                                                        
      282                              foundOpportunity = true;
      275 -                            break; // 找到一个机会就够了      
      283 +                            break;                            
      284                          }
      285                          checked++;
      286                      }
     ...
      295              }
      296          }
      297  
      290 -        printSummary(directTrains.size(), hasTicketCount, noTi
          -cketCount, buyLongOpportunities);                             
      298 +        // ===== 买长乘短有票汇总 =====                       
      299 +        if (!buyLongResults.isEmpty()) {                      
      300 +            System.out.println();                             
      301 +            System.out.println("============ 买长乘短有票车次 
          +(" + buyLongResults.size() + " 个) ============");            
      302 +            System.out.println(String.format("%-8s %-8s %-8s %
          +-10s %-6s %-6s %-6s %s",                                      
      303 +                    "车次", "出发站", "目的地", "购票到站", " 
          +出发", "到达", "历时", "余票"));                              
      304 +            System.out.println("-".repeat(100));              
      305 +            for (BuyLongResult r : buyLongResults) {          
      306 +                System.out.println(String.format("%-8s %-8s %-
          +8s %-10s %-6s %-6s %-6s %s",                                  
      307 +                        r.originalTrain.getStationTrainCode(),
      308 +                        r.originalTrain.getFromStationName(), 
      309 +                        r.originalTrain.getToStationName(),   
      310 +                        r.buyToStation,                       
      311 +                        r.originalTrain.getStartTime(),       
      312 +                        r.originalTrain.getArriveTime(),      
      313 +                        r.originalTrain.getDuration(),        
      314 +                        r.extendedTrain.getTicketSummary())); 
      315 +            }                                                 
      316 +        }                                                     
      317 +                                                              
      318 +        printSummary(directTrains.size(), hasTicketCount, noTi
          +cketCount, buyLongResults.size());                            
      319      }
      320  
      321      /**
      294 -     * 查询延伸站点的余票                                     
      295 -     * @return 是否找到买长乘短机会                           
      322 +     * 查询延伸站点的余票，返回有票的 TrainInfo，无票返回 null
      323       */
      297 -    private boolean checkExtendedTicket(Station fromStation, T
          -rainInfo train, TrainStop extStop, String date) {             
      324 +    private TrainInfo findExtendedTicket(Station fromStation, 
          +TrainInfo train, TrainStop extStop, String date) {            
      325          String extCode = extStop.getStationCode();
      326          if (extCode == null || extCode.isEmpty()) {
      327              Station extStation = stationService.getByName(extS
           top.getStationName());
      328              if (extStation != null) {
      329                  extCode = extStation.getCode();
      330              } else {
      304 -                return false;                                 
      331 +                return null;                                  
      332              }
      333          }
      334  
     ...
      338  
      339              for (TrainInfo extTrain : extTickets) {
      340                  if (extTrain.getStationTrainCode().equals(trai
           n.getStationTrainCode())) {
      314 -                    if (extTrain.hasAvailableTicket()) {      
      315 -                        System.out.println("    ★ 买长乘短机会
          -! "                                                           
      316 -                                + fromStation.getName() + " → 
          -" + extStop.getStationName()                                  
      317 -                                + " (" + train.getStationTrain
          -Code() + "): "                                                
      318 -                                + extTrain.getTicketSummary())
          -;                                                             
      319 -                        return true;                          
      320 -                    }                                         
      321 -                    return false;                             
      341 +                    return extTrain.hasAvailableTicket() ? ext
          +Train : null;                                                 
      342                  }
      343              }
      344          } catch (Exception e) {
      345              // 查询失败，跳过
      346          }
      327 -        return false;                                         
      347 +        return null;                                          
      348      }
      349  
      350 +    /**                                                       
      351 +     * 买长乘短查询结果                                       
      352 +     */                                                       
      353 +    private static class BuyLongResult {                      
      354 +        final TrainInfo originalTrain;   // 原始车次（直达无票
          +）                                                            
      355 +        final TrainInfo extendedTrain;   // 延伸查询（有票）  
      356 +        final String buyToStation;       // 购票到站名        
      357 +                                                              
      358 +        BuyLongResult(TrainInfo originalTrain, TrainInfo exten
          +dedTrain, String buyToStation) {                              
      359 +            this.originalTrain = originalTrain;               
      360 +            this.extendedTrain = extendedTrain;               
      361 +            this.buyToStation = buyToStation;                 
      362 +        }                                                     
      363 +    }                                                         
      364 +                                                              
      365      private void printSummary(int total, int hasTicket, int no
           Ticket, int buyLong) {
      366          System.out.println();
      367          System.out.println("========== 查询总结 ==========");
      368          System.out.println("车次总数: " + total);
      334 -        System.out.println("有票车次: " + hasTicket);         
      335 -        System.out.println("无票车次: " + noTicket);          
      336 -        System.out.println("买长乘短机会: " + buyLong);       
      369 +        System.out.println("直达有票: " + hasTicket);         
      370 +        System.out.println("直达无票: " + noTicket);          
      371 +        System.out.println("买长乘短有票: " + buyLong);       
      372          System.out.println("==============================");
      373      }
      374  

● Bash(cd "D:/software/develop_tools/git/gitee/ticket" && mvn package -q 2>&1)
  ⎿  (No content)

● 编译成功。现在输出分四个区域：

  ==================== 有票车次 (8 个) ====================
  车次     出发站    到达站    终到站    出发   到达   历时   商务   一等   二等
     硬卧   硬座
  ...

  ==================== 无票车次 (95 个) ====================
  ...

  【第2步】分析买长乘短机会...
  [1/76] G9782 (福田→长沙南, 终到: 娄底南)
      ★ 买长乘短机会! ...
  ...

  ============ 买长乘短有票车次 (16 个) ============
  车次     出发站    目的地    购票到站      出发   到达   历时   余票
  ------------------------------------------------------------------------------
  ----------------------
  G9782    福田     长沙南    娄底南       01:51  05:35  03:44  无座:有
  G4848    深圳北   长沙南    郑州东       03:45  06:41  02:56  商务座:1
  G1026    福田     长沙南    北京西       06:35  10:09  03:34  无座:9
  ...

  ========== 查询总结 ==========
  车次总数: 103
  直达有票: 8
  直达无票: 95
  买长乘短有票: 16
  ==============================

  最后的"买长乘短有票车次"表格会集中展示所有机会，包含车次、出发站、目的地、购票
  到站、时间和余票，一目了然。